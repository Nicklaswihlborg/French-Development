<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>French Development — B2 Journey</title>
  <meta name="description" content="All-in-one single-file French practice app with progress tracking, goals, speaking, listening, comprehension, vocabulary, and daily phrases." />
  <style>
    :root{
      --bg1:#0b1020; --bg2:#111827; --fg:#e5e7eb; --muted:#cbd5e1;
      --card:rgba(255,255,255,.06); --brd:rgba(255,255,255,.14);
      --accent:#60a5fa; --ok:#34d399; --warn:#fbbf24; --bad:#f87171;
      --link:#93c5fd;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--fg);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:
        radial-gradient(1000px 700px at 15% -10%, #1e293b 0%, transparent 60%),
        radial-gradient(900px 700px at 85% 10%, #0f172a 0%, transparent 55%),
        linear-gradient(180deg,var(--bg2),var(--bg1));
    }
    a{color:var(--link)}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    .app-title{display:flex;align-items:center;gap:10px}
    h1{margin:0;font-size:1.5rem}
    .badge{border:1px solid var(--brd);background:rgba(255,255,255,.06);padding:6px 10px;border-radius:999px;font-size:.9rem}
    nav{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 18px}
    nav button{
      border:1px solid var(--brd);background:rgba(255,255,255,.06);
      color:var(--fg);padding:8px 12px;border-radius:10px;cursor:pointer
    }
    nav button.active{outline:2px solid var(--accent)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-12{grid-column:span 12}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    @media (max-width:900px){ .col-6{grid-column:span 12} .col-4{grid-column:span 12} }
    .card{background:var(--card);border:1px solid var(--brd);border-radius:16px;padding:16px}
    .muted{color:var(--muted)}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn{
      border:1px solid var(--brd);background:rgba(255,255,255,.06);
      color:var(--fg);padding:10px 12px;border-radius:10px;cursor:pointer
    }
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.ok{border-color:rgba(16,185,129,.35);background:rgba(16,185,129,.15)}
    .btn.warn{border-color:rgba(251,191,36,.35);background:rgba(251,191,36,.15)}
    .btn.bad{border-color:rgba(248,113,113,.35);background:rgba(248,113,113,.15)}
    .k{padding:2px 8px;border-radius:999px;border:1px solid var(--brd);background:rgba(255,255,255,.05)}
    .small{font-size:.9rem}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .bar{height:12px;background:rgba(255,255,255,.08);border:1px solid var(--brd);border-radius:999px;overflow:hidden}
    .bar>span{display:block;height:100%;background:linear-gradient(90deg,#60a5fa,#34d399)}
    textarea{width:100%;min-height:150px;border:1px solid var(--brd);border-radius:12px;background:rgba(0,0,0,.25);color:var(--fg);padding:12px}
    input[type="text"],input[type="number"]{
      width:100%;border:1px solid var(--brd);border-radius:10px;background:rgba(0,0,0,.25);color:var(--fg);padding:10px
    }
    table{width:100%;border-collapse:collapse}
    td,th{border-bottom:1px solid var(--brd);padding:8px 6px}
    details summary{cursor:pointer}
    hr{border:none;border-top:1px solid var(--brd);opacity:.6;margin:12px 0}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--brd);background:rgba(255,255,255,.06);font-size:.85rem}
    .section-title{display:flex;align-items:center;gap:8px;margin:0 0 10px}
    .chip{border:1px dashed var(--brd);border-radius:8px;padding:6px 10px}
    .footer-note{opacity:.8}
    .hidden{display:none !important}
    .list{margin:0;padding-left:18px}
    .list li{margin:4px 0}
    .score{font-weight:600}
    canvas{width:100%;height:150px;border:1px solid var(--brd);border-radius:10px;background:rgba(255,255,255,.03)}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="header">
      <div class="app-title">
        <h1>🇫🇷 French Development — B2 Journey</h1>
      </div>
      <div class="row small">
        <span id="streakBadge" class="badge">🔥 Streak: 0</span>
        <span id="goalBadge" class="badge">🎯 Objectif: 30 xp/jour</span>
        <span id="b2Badge" class="badge">🎓 Objectif B2: <span id="daysToB2"></span> jours</span>
      </div>
    </header>

    <nav id="tabs"></nav>

    <!-- DASHBOARD -->
    <section id="view-dashboard" class="view">
      <div class="grid">
        <div class="col-6">
          <div class="card">
            <div class="section-title"><h2>📈 Progression du jour</h2><span class="chip small">se réinitialise chaque jour</span></div>
            <div class="row small">
              <span>Objectif:</span><span id="goalVal" class="k mono">30 xp</span>
              <button class="btn" id="decGoal">-</button>
              <button class="btn" id="incGoal">+</button>
              <span>Gagné:</span><span id="xpVal" class="k mono">0</span>
            </div>
            <div class="bar" style="margin-top:8px"><span id="xpBar" style="width:0%"></span></div>
            <div class="row" style="margin-top:10px">
              <button class="btn" data-xp="5" data-flag="listening">+5 Écoute</button>
              <button class="btn" data-xp="5" data-flag="speaking">+5 Parler</button>
              <button class="btn" data-xp="5" data-flag="reading">+5 Lecture</button>
              <button class="btn" data-xp="5" data-flag="vocab">+5 Vocabulaire</button>
              <button class="btn" data-xp="5" data-flag="phrases">+5 Phrases</button>
              <button class="btn warn" id="resetDay">Réinitialiser</button>
            </div>
            <p class="muted small">Conseil : visez 30–45 xp/jour. 5 xp ≈ 5–10 minutes d’effort concentré.</p>
          </div>
        </div>
        <div class="col-6">
          <div class="card">
            <div class="section-title"><h2>📊 14 derniers jours</h2><span class="chip small">tendance & cumul</span></div>
            <canvas id="chart14"></canvas>
            <div class="row small" style="margin-top:8px">
              <span>Total 14j: <span id="sum14" class="mono">0</span> xp</span>
              <span>Semaine en cours: <span id="wkXp" class="mono">0</span> xp</span>
              <span>Streak jours ≥ objectif: <span id="streakDays" class="mono">0</span></span>
            </div>
          </div>
        </div>

        <div class="col-4">
          <div class="card">
            <div class="section-title"><h2>🎯 Objectifs</h2></div>
            <div class="row small">
              <label for="dailyMinutes" class="muted">Minutes/jour:</label>
              <input id="dailyMinutes" type="number" min="5" step="5" />
              <button class="btn" id="saveDailyMinutes">Sauver</button>
            </div>
            <div class="row small" style="margin-top:6px">
              <label for="weeklyHours" class="muted">Heures/semaine:</label>
              <input id="weeklyHours" type="number" min="1" step="1" />
              <button class="btn" id="saveWeeklyHours">Sauver</button>
            </div>
            <hr />
            <p class="small">Recommandé pour passer A2 → B2 d’ici fin d’année : <strong>7–10 h / semaine</strong> + pratique active quotidienne (parler/écouter).</p>
            <p class="muted small">Aujourd’hui: <span id="todayPlan"></span></p>
          </div>
        </div>

        <div class="col-4">
          <div class="card">
            <div class="section-title"><h2>🧱 Plan B2</h2></div>
            <ul class="list small">
              <li><strong>Quotidien (30–45 min):</strong> 10 min vocab SRS, 10 min compréhension, 10–15 min parler/écouter.</li>
              <li><strong>Hebdo (1–2×):</strong> 30–45 min conversation réelle (tuteur ou tandem).</li>
              <li><strong>Mensuel:</strong> mini test DELF B1/B2 (lecture, écoute, production).</li>
              <li><strong>Qualité > quantité:</strong> feedback, correction active, révision espacée.</li>
            </ul>
          </div>
        </div>

        <div class="col-4">
          <div class="card">
            <div class="section-title"><h2>🛠️ Données</h2></div>
            <div class="row">
              <button class="btn" id="exportData">Exporter</button>
              <label class="btn">
                Importer <input id="importData" type="file" accept="application/json" class="hidden" />
              </label>
              <button class="btn bad" id="factoryReset">Réinitialisation complète</button>
            </div>
            <p class="small muted">Tout est stocké <em>localement</em> (localStorage). L’export crée un fichier .json à conserver.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- COMPREHENSION -->
    <section id="view-comprehension" class="view hidden">
      <div class="card">
        <div class="section-title"><h2>📰 Compréhension (actualités simplifiées)</h2><span class="chip small">FR ⇄ EN + questions</span></div>
        <div class="row">
          <button class="btn" id="nextArticle">Nouveau texte</button>
          <button class="btn" id="toggleArticleLang">Afficher traduction (EN)</button>
          <button class="btn" id="speakArticle">🔊 Écouter</button>
          <button class="btn" id="stopSpeakArticle">⏸️ Stop</button>
          <button class="btn ok" id="markCompXP">+5 xp</button>
        </div>
        <textarea id="articleBox"></textarea>
        <div id="articleQA" class="small" style="margin-top:8px"></div>
        <p class="muted small">Astuce: écoutez d’abord, puis lisez, puis répondez mentalement aux questions avant de révéler.</p>
      </div>
    </section>

    <!-- SPEAKING -->
    <section id="view-speaking" class="view hidden">
      <div class="card">
        <div class="section-title"><h2>🎤 Parler</h2><span class="chip small">Reconnaissance vocale (Chrome) + invites</span></div>
        <div class="row small">
          <span id="micState" class="pill">🎙️ Micro: <span class="mono">checking…</span></span>
          <span id="recState" class="pill">🗣️ État: <span class="mono">inactif</span></span>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="askMic">Autoriser micro</button>
          <button class="btn" id="startRec">Démarrer</button>
          <button class="btn bad" id="stopRec" disabled>Arrêter</button>
          <button class="btn ok" id="markSpeakXP">+5 xp</button>
        </div>
        <p class="muted small">Choisissez un sujet et parlez 60–120 s. Visez des phrases complètes, connecteurs (d’abord, ensuite, pourtant…).</p>
        <div class="row">
          <select id="promptSelect" class="btn">
            <option value="daily">Routine quotidienne</option>
            <option value="opinion">Donner une opinion</option>
            <option value="past">Raconter un souvenir</option>
            <option value="future">Planifier / envisager</option>
            <option value="work">Travail / projet</option>
          </select>
          <button class="btn" id="newPrompt">Nouvelle invite</button>
          <button class="btn" id="speakPrompt">🔊 Lire l’invite</button>
        </div>
        <textarea id="promptBox" class="small" readonly></textarea>
        <textarea id="speechOut" placeholder="Votre transcription apparaîtra ici…"></textarea>
      </div>
    </section>

    <!-- LISTENING -->
    <section id="view-listening" class="view hidden">
      <div class="card">
        <div class="section-title"><h2>👂 Écoute / Dictée</h2><span class="chip small">Taper ce que vous entendez</span></div>
        <div class="row">
          <button class="btn" id="playDictation">▶️ Lire</button>
          <button class="btn" id="replayDictation">↻ Relire</button>
          <button class="btn ok" id="markListenXP">+5 xp</button>
        </div>
        <p id="dictationHint" class="muted small"></p>
        <textarea id="dictationInput" placeholder="Écrivez ce que vous entendez ici…"></textarea>
        <div class="row">
          <button class="btn" id="checkDictation">Vérifier</button>
          <span id="dictationScore" class="score"></span>
        </div>
        <details style="margin-top:8px">
          <summary>Afficher le texte cible</summary>
          <p id="dictationTarget" class="small"></p>
        </details>
      </div>
    </section>

    <!-- VOCABULARY (SRS) -->
    <section id="view-vocab" class="view hidden">
      <div class="card">
        <div class="section-title"><h2>📚 Vocabulaire (répétition espacée)</h2><span class="chip small">Due aujourd’hui: <span id="dueCount">0</span></span></div>
        <div class="grid">
          <div class="col-6">
            <h3>Ajouter des mots</h3>
            <div class="row">
              <input id="vFr" type="text" placeholder="mot (FR) — ex: envisager" />
              <input id="vEn" type="text" placeholder="translation (EN) — ex: to consider" />
            </div>
            <div class="row" style="margin-top:6px">
              <button class="btn" id="addWord">Ajouter</button>
              <button class="btn" id="exportVocab">Exporter</button>
              <label class="btn">Importer <input id="importVocab" type="file" accept="application/json" class="hidden"/></label>
              <button class="btn bad" id="clearVocab">Effacer tout</button>
            </div>
            <hr/>
            <table id="vTable">
              <thead><tr><th>FR</th><th>EN</th><th>Prochain</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="col-6">
            <h3>Quiz (FR → EN)</h3>
            <div class="row small">
              <span class="muted">Cartes dues: <span id="dueNow">0</span></span>
              <button class="btn" id="startQuiz">Commencer</button>
              <button class="btn" id="skipCard" disabled>Passer</button>
            </div>
            <div class="card" style="margin-top:8px">
              <div id="quizFront" class="section-title"><h2>—</h2></div>
              <input id="quizAnswer" type="text" placeholder="Votre traduction…" />
              <div class="row" style="margin-top:8px">
                <button class="btn" id="revealA">Révéler</button>
                <span id="quizBack" class="k"></span>
              </div>
              <div class="row" style="margin-top:8px">
                <button class="btn bad" id="rateAgain" disabled>Encore (0)</button>
                <button class="btn warn" id="rateHard" disabled>Difficile (2)</button>
                <button class="btn" id="rateGood" disabled>Bien (3)</button>
                <button class="btn ok" id="rateEasy" disabled>Facile (4)</button>
                <button class="btn ok" id="markVocabXP" disabled>+5 xp</button>
              </div>
            </div>
            <p class="muted small">Algorithme SRS simple (type SM-2 léger) : bonnes réponses → intervalle ↑; erreurs → révisions plus fréquentes.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- DAILY PHRASES -->
    <section id="view-phrases" class="view hidden">
      <div class="card">
        <div class="section-title"><h2>🗣️ Phrases courantes — entraînement quotidien</h2><span class="chip small">10 par jour</span></div>
        <div class="row">
          <button class="btn" id="newPhrases">Nouveau set</button>
          <button class="btn" id="speakAllPhrases">🔊 Écouter tout</button>
          <button class="btn ok" id="markPhrasesXP">+5 xp</button>
        </div>
        <div id="phraseList" class="small" style="margin-top:8px"></div>
      </div>
    </section>

    <p class="small muted footer-note">Conseil: répartissez la pratique (parler/écouter/lire/vocab) chaque jour; gardez la cadence plutôt que des marathons irréguliers.</p>
  </div>

  <script>
    /* ===========================
       Utilities & Storage
       =========================== */
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const todayKey = () => new Date().toISOString().slice(0,10);
    const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; };
    const fmt = (d)=> new Date(d).toISOString().slice(0,10);
    const weekNumber = (date = new Date())=>{
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7; d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      return Math.ceil(((d - yearStart)/86400000 + 1)/7);
    };
    const store = {
      get(k, def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def } catch { return def } },
      set(k, v){ localStorage.setItem(k, JSON.stringify(v)) }
    };

    /* ===========================
       Global Keys / Defaults
       =========================== */
    const K = {
      goalDailyXP: 'fd_goal_daily_xp',
      dailyMinutes: 'fd_daily_minutes',
      weeklyHours: 'fd_weekly_hours',
      xpByDay: 'fd_xp_by_day',        // { 'YYYY-MM-DD': number }
      flagsByDay: 'fd_flags_by_day',  // { date: {listening,speaking,reading,vocab,phrases} }
      vocabList: 'fd_vocab_list',     // array of cards
      dueSeed: 'fd_due_seed',         // last generated daily phrase seed
      phrasesDone: 'fd_phrases_done', // {date:true}
      dataVersion: 'fd_data_v1'
    };
    // defaults
    if (store.get(K.goalDailyXP)==null) store.set(K.goalDailyXP, 30);
    if (store.get(K.dailyMinutes)==null) store.set(K.dailyMinutes, 40);
    if (store.get(K.weeklyHours)==null) store.set(K.weeklyHours, 8);
    if (store.get(K.xpByDay)==null) store.set(K.xpByDay, {});
    if (store.get(K.flagsByDay)==null) store.set(K.flagsByDay, {});
    if (store.get(K.vocabList)==null) store.set(K.vocabList, [
      {id:1, fr:'envisager', en:'to consider', ease:2.5, interval:0, reps:0, due:fmt(todayKey())},
      {id:2, fr:'mettre en place', en:'to set up', ease:2.5, interval:0, reps:0, due:fmt(todayKey())},
      {id:3, fr:'piste cyclable', en:'bike lane', ease:2.5, interval:0, reps:0, due:fmt(todayKey())},
    ]);

    /* ===========================
       Navigation
       =========================== */
    const VIEWS = [
      {id:'dashboard', label:'🏠 Tableau de bord'},
      {id:'comprehension', label:'📰 Compréhension'},
      {id:'speaking', label:'🎤 Parler'},
      {id:'listening', label:'👂 Écoute'},
      {id:'vocab', label:'📚 Vocabulaire'},
      {id:'phrases', label:'🗣️ Phrases'}
    ];
    function initTabs(){
      const nav = $('#tabs');
      VIEWS.forEach((v,i)=>{
        const b = document.createElement('button');
        b.className = 'btn' + (i===0?' active':'');
        b.textContent = v.label;
        b.dataset.view = v.id;
        b.onclick = ()=>showView(v.id, b);
        nav.appendChild(b);
      });
      showView('dashboard', nav.querySelector('button'));
    }
    function showView(id, btn){
      $$('.view').forEach(v => v.classList.add('hidden'));
      $('#view-'+id).classList.remove('hidden');
      $$('#tabs button').forEach(b => b.classList.remove('active'));
      btn && btn.classList.add('active');
    }

    /* ===========================
       XP / Progress / Goals
       =========================== */
    function getXP(d=todayKey()){ const map=store.get(K.xpByDay,{}); return map[d]||0; }
    function setXP(val, d=todayKey()){ const map=store.get(K.xpByDay,{}); map[d]=val; store.set(K.xpByDay,map); }
    function addXP(amount, flag=null){
      const d = todayKey();
      const curr = getXP(d) + amount;
      setXP(curr);
      if (flag){
        const flags = store.get(K.flagsByDay,{});
        flags[d] = flags[d] || {listening:false,speaking:false,reading:false,vocab:false,phrases:false};
        flags[d][flag] = true; store.set(K.flagsByDay, flags);
      }
      refreshProgress();
      draw14DayChart();
    }
    function dailyFlags(d=todayKey()){
      const f = store.get(K.flagsByDay,{})[d] || {listening:false,speaking:false,reading:false,vocab:false,phrases:false};
      return f;
    }
    function refreshProgress(){
      const goal = store.get(K.goalDailyXP,30);
      $('#goalVal').textContent = goal + ' xp';
      $('#goalBadge').textContent = `🎯 Objectif: ${goal} xp/jour`;

      const xp = getXP();
      $('#xpVal').textContent = xp;
      $('#xpBar').style.width = Math.min(100, Math.round((xp/goal)*100)) + '%';

      // disable buttons already flagged today
      const f = dailyFlags();
      document.querySelectorAll('[data-flag]').forEach(btn=>{
        const flag = btn.getAttribute('data-flag');
        btn.disabled = !!f[flag];
        btn.onclick = ()=>{ addXP(parseInt(btn.dataset.xp,10), flag); };
      });

      // Streak
      const streak = calcStreak(goal);
      $('#streakBadge').textContent = `🔥 Streak: ${streak}`;
      $('#streakDays').textContent = streak;

      // Week XP
      $('#wkXp').textContent = calcThisWeekXP();

      // Today plan
      $('#dailyMinutes').value = store.get(K.dailyMinutes,40);
      $('#weeklyHours').value = store.get(K.weeklyHours,8);
      $('#todayPlan').textContent = `${store.get(K.dailyMinutes)} min • focus: parler/écouter + vocab (SRS)`;
    }
    function calcThisWeekXP(){
      const map = store.get(K.xpByDay,{});
      const d = new Date();
      const wk = weekNumber(d);
      let sum = 0;
      Object.entries(map).forEach(([k,v])=>{
        const dt = new Date(k);
        if (weekNumber(dt)===wk && dt.getFullYear()===d.getFullYear()) sum+=v||0;
      });
      return sum;
    }
    function calcStreak(goal){
      const map = store.get(K.xpByDay,{});
      let s=0, day=new Date();
      while(true){
        const key = day.toISOString().slice(0,10);
        if ((map[key]||0) >= goal){ s++; day = addDays(day,-1); }
        else break;
      }
      return s;
    }
    function draw14DayChart(){
      const c = $('#chart14'); const g = c.getContext('2d');
      const map = store.get(K.xpByDay,{});
      const today = new Date();
      const days = [];
      for(let i=13;i>=0;i--){ const d=addDays(today,-i); const k=d.toISOString().slice(0,10); days.push({k, xp: map[k]||0}); }
      // clear
      g.clearRect(0,0,c.width,c.height);
      const W=c.width, H=c.height, pad=20, bw=(W-2*pad)/days.length - 6;
      const max = Math.max(30, ...days.map(d=>d.xp));
      let sum=0;
      days.forEach((d,i)=>{ sum+=d.xp; const x=pad+i*((W-2*pad)/days.length), h=(H-2*pad)*(d.xp/max); g.fillRect(x, H-pad-h, bw, h); });
      $('#sum14').textContent = sum;
    }

    // Controls
    $('#incGoal').onclick = ()=>{ store.set(K.goalDailyXP, store.get(K.goalDailyXP,30)+5); refreshProgress(); };
    $('#decGoal').onclick = ()=>{ store.set(K.goalDailyXP, Math.max(10, store.get(K.goalDailyXP,30)-5)); refreshProgress(); };
    $('#resetDay').onclick = ()=>{ setXP(0); const flags=store.get(K.flagsByDay,{}); flags[todayKey()]={listening:false,speaking:false,reading:false,vocab:false,phrases:false}; store.set(K.flagsByDay,flags); refreshProgress(); };
    $('#saveDailyMinutes').onclick = ()=>{ store.set(K.dailyMinutes, Math.max(10, parseInt($('#dailyMinutes').value||40,10))); refreshProgress(); };
    $('#saveWeeklyHours').onclick = ()=>{ store.set(K.weeklyHours, Math.max(1, parseInt($('#weeklyHours').value||8,10))); refreshProgress(); };

    // Countdown to Dec 31 (B2 goal)
    function setB2Countdown(){
      const now=new Date(); const end=new Date(now.getFullYear(),11,31);
      const days=Math.max(0, Math.ceil((end - now)/86400000));
      $('#daysToB2').textContent = days;
    }

    /* ===========================
       Data Export / Import
       =========================== */
    $('#exportData').onclick = ()=>{
      const data = {};
      Object.values(K).forEach(key=> data[key]=store.get(key));
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='french_dev_backup.json'; a.click();
      URL.revokeObjectURL(url);
    };
    $('#importData').onchange = (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const r = new FileReader();
      r.onload = ()=>{
        try{ const obj=JSON.parse(r.result);
          Object.entries(obj).forEach(([k,v])=> localStorage.setItem(k, JSON.stringify(v)));
          alert('Importation réussie. Rechargement…'); location.reload();
        }catch{ alert('Fichier invalide'); }
      };
      r.readAsText(file);
    };
    $('#factoryReset').onclick = ()=>{
      if(!confirm('Tout effacer et repartir de zéro ?')) return;
      Object.values(K).forEach(k=> localStorage.removeItem(k));
      location.reload();
    };

    /* ===========================
       Comprehension (Articles)
       =========================== */
    const ARTICLES = [
      {
        title:'Le vélo en ville',
        fr:"Aujourd’hui, la mairie a ouvert une nouvelle piste cyclable au centre-ville pour réduire la circulation et la pollution. Les habitants disent que la piste est large et sûre. Les commerçants espèrent voir plus de clients, car il sera plus facile d’accéder aux magasins à vélo.",
        en:"Today, the city hall opened a new bike lane downtown to reduce traffic and pollution. Residents say the lane is wide and safe. Shop owners hope to see more customers because it will be easier to reach stores by bike.",
        qs:["Pourquoi la mairie a-t-elle ouvert une nouvelle piste cyclable ?","Que pensent les habitants de la piste ?","Qu’espèrent les commerçants ?"],
        ans:["Pour réduire la circulation et la pollution.","Elle est large et sûre.","Avoir plus de clients grâce à l’accès plus facile aux magasins."]
      },
      {
        title:"La météo et l’agriculture",
        fr:"Après plusieurs semaines de pluie, les agriculteurs profitent enfin du soleil pour récolter. Les experts disent que la qualité sera correcte, mais certains fruits sont plus petits que d’habitude. Les marchés locaux restent bien approvisionnés.",
        en:"After several weeks of rain, farmers are finally enjoying the sun to harvest. Experts say quality will be fine, but some fruits are smaller than usual. Local markets remain well supplied.",
        qs:["Quel temps faisait-il ces dernières semaines ?","Quel est l’impact sur les fruits ?","Comment vont les marchés locaux ?"],
        ans:["Il a plu pendant plusieurs semaines.","Certains fruits sont plus petits que d’habitude.","Ils restent bien approvisionnés."]
      },
      {
        title:"Le train du matin",
        fr:"La compagnie ferroviaire a ajouté deux trains le matin pour éviter la foule aux heures de pointe. Les voyageurs remarquent des trajets plus calmes et plus rapides. L’entreprise surveille la fréquentation avant de décider de nouvelles lignes.",
        en:"The railway company added two morning trains to avoid crowds at rush hour. Travelers are noticing calmer, faster rides. The company is monitoring ridership before deciding on new routes.",
        qs:["Combien de trains ont été ajoutés le matin ?","Qu’est-ce que les voyageurs remarquent ?","Que fera l’entreprise ensuite ?"],
        ans:["Deux trains.","Des trajets plus calmes et plus rapides.","Elle surveillera la fréquentation avant de décider de nouvelles lignes."]
      }
    ];
    let showEN=false, artIdx=0, ttsUtter=null;
    function renderArticle(){
      const a=ARTICLES[artIdx%ARTICLES.length];
      $('#articleBox').value = showEN? a.en : a.fr;
      $('#articleQA').innerHTML = `
        <div class="row small"><span class="pill">Texte: ${a.title}</span></div>
        <ol class="small">${a.qs.map((q,i)=>`<li>${q} <details class="muted"><summary>Réponse suggérée</summary>${a.ans[i]}</details></li>`).join('')}</ol>
      `;
    }
    $('#nextArticle').onclick = ()=>{ artIdx++; renderArticle(); };
    $('#toggleArticleLang').onclick = ()=>{ showEN=!showEN; $('#toggleArticleLang').textContent = showEN?'Afficher le texte (FR)':'Afficher traduction (EN)'; renderArticle(); };
    $('#speakArticle').onclick = ()=>{
      if(!('speechSynthesis' in window)){ alert("Synthèse vocale non disponible."); return; }
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance($('#articleBox').value);
      u.lang='fr-FR'; u.rate=0.95; u.pitch=1;
      ttsUtter=u; speechSynthesis.speak(u);
    };
    $('#stopSpeakArticle').onclick = ()=> speechSynthesis.cancel();
    $('#markCompXP').onclick = ()=> addXP(5,'reading');

    /* ===========================
       Speaking (Prompts + SR)
       =========================== */
    const PROMPTS = {
      daily:[
        "Décris ta routine du matin en cinq étapes.",
        "Quelles habitudes saines veux-tu mettre en place ce mois-ci ?",
        "Qu’as-tu fait hier soir après le travail ?"
      ],
      opinion:[
        "Es-tu d’accord avec l’idée de travailler à distance ? Pourquoi/pourquoi pas ?",
        "Les réseaux sociaux sont-ils utiles ou dangereux ? Donne deux raisons.",
        "Faut-il limiter les voitures en centre-ville ?"
      ],
      past:[
        "Raconte un souvenir d’enfance marquant.",
        "Parle d’un voyage récent: où, avec qui, et pourquoi c’était bien.",
        "Décris une difficulté que tu as surmontée."
      ],
      future:[
        "Quels sont tes objectifs d’ici six mois ? Comment vas-tu t’y prendre ?",
        "Où te vois-tu dans trois ans, professionnellement ?",
        "Explique un projet que tu voudrais réaliser le week-end prochain."
      ],
      work:[
        "Explique ton rôle actuel et un projet sur lequel tu travailles.",
        "Décris un problème au travail et ta solution.",
        "Comment organises-tu tes priorités dans la semaine ?"
      ]
    };
    function randomPrompt(cat){ const arr=PROMPTS[cat]||PROMPTS.daily; return arr[Math.floor(Math.random()*arr.length)]; }
    function setPrompt(cat){ $('#promptBox').value = randomPrompt(cat); }
    $('#newPrompt').onclick = ()=> setPrompt($('#promptSelect').value);
    $('#promptSelect').onchange = ()=> setPrompt($('#promptSelect').value);
    $('#speakPrompt').onclick = ()=>{
      if(!('speechSynthesis' in window)){ alert("Synthèse vocale non disponible."); return; }
      const u = new SpeechSynthesisUtterance($('#promptBox').value || randomPrompt('daily'));
      u.lang='fr-FR'; u.rate=1; speechSynthesis.speak(u);
    };

    const micState = $('#micState'), recState = $('#recState'), out = $('#speechOut');
    $('#askMic').onclick = async ()=>{
      try{ const s=await navigator.mediaDevices.getUserMedia({audio:true}); s.getTracks().forEach(t=>t.stop()); micState.innerHTML='🎙️ Micro: <span class="mono">granted</span>'; }
      catch{ micState.innerHTML='🎙️ Micro: <span class="mono">blocked</span>'; alert("Autorisez le micro pour github.io"); }
    };
    (async function initMicStatus(){
      if(!navigator.mediaDevices?.getUserMedia){ micState.innerHTML='🎙️ Micro: <span class="mono">unsupported</span>'; return; }
      try{
        const r = await navigator.permissions?.query({name:'microphone'});
        if(r){ micState.innerHTML = '🎙️ Micro: <span class="mono">'+r.state+'</span>'; r.onchange=()=> micState.innerHTML='🎙️ Micro: <span class="mono">'+r.state+'</span>'; }
        else micState.innerHTML='🎙️ Micro: <span class="mono">unknown</span>';
      }catch{ micState.innerHTML='🎙️ Micro: <span class="mono">unknown</span>'; }
    })();

    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recog=null;
    function startRec(){
      if(!SR){ alert("La reconnaissance vocale n'est pas disponible ici. Essayez Chrome."); return; }
      if(recog) return;
      recog=new SR(); recog.lang='fr-FR'; recog.interimResults=true; recog.continuous=true; out.value='';
      recog.onresult=(e)=>{ let txt=''; for(let i=0;i<e.results.length;i++){ txt += e.results[i][0].transcript + (e.results[i].isFinal?'\n':' '); } out.value=txt.trim(); };
      recog.onerror=(e)=> console.warn(e);
      recog.onend=()=>{ recState.innerHTML='🗣️ État: <span class="mono">inactif</span>'; $('#stopRec').disabled=true; recog=null; };
      try{ recog.start(); recState.innerHTML='🗣️ État: <span class="mono">écoute…</span>'; $('#stopRec').disabled=false; }
      catch{ alert("Impossible de démarrer. Autorisez le micro, puis réessayez."); }
    }
    function stopRec(){ if(recog) recog.stop(); }
    $('#startRec').onclick = startRec;
    $('#stopRec').onclick = stopRec;
    $('#markSpeakXP').onclick = ()=> addXP(5,'speaking');

    /* ===========================
       Listening (Dictation)
       =========================== */
    const DICT = [
      {text:"Je prendrai le train de sept heures demain matin.", hint:"Transport / futur proche"},
      {text:"Pouvez-vous répéter plus lentement, s'il vous plaît ?", hint:"Demander poliment"},
      {text:"Nous avons décidé d’envisager une autre solution.", hint:"Décision / alternatives"},
      {text:"Il a oublié de mettre en place la réunion.", hint:"Organisation au travail"}
    ];
    let dIdx=0, lastUtter=null;
    function playCurrentDictation(){
      const d=DICT[dIdx%DICT.length];
      $('#dictationHint').textContent = "Indice : " + d.hint;
      $('#dictationTarget').textContent = d.text;
      if(!('speechSynthesis' in window)){ alert("Synthèse vocale non disponible."); return; }
      speechSynthesis.cancel();
      const u=new SpeechSynthesisUtterance(d.text); u.lang='fr-FR'; u.rate=0.95; lastUtter=u; speechSynthesis.speak(u);
    }
    $('#playDictation').onclick = ()=>{ playCurrentDictation(); };
    $('#replayDictation').onclick = ()=>{ if(lastUtter) speechSynthesis.speak(lastUtter); else playCurrentDictation(); };
    $('#checkDictation').onclick = ()=>{
      const target = $('#dictationTarget').textContent.trim().toLowerCase();
      const guess = $('#dictationInput').value.trim().toLowerCase();
      const score = similarityWords(target, guess);
      $('#dictationScore').textContent = `Score: ${Math.round(score*100)}%`;
    };
    $('#markListenXP').onclick = ()=> addXP(5,'listening');
    function similarityWords(a,b){
      const wa=a.replace(/[^\p{L}\p{N}\s']/gu,'').split(/\s+/);
      const wb=b.replace(/[^\p{L}\p{N}\s']/gu,'').split(/\s+/);
      const set=new Set(wa); let match=0; wb.forEach(w=>{ if(set.has(w)) match++; });
      return wa.length? match/wa.length : 0;
    }

    /* ===========================
       Vocabulary (SRS)
       =========================== */
    let vocab = store.get(K.vocabList,[]);
    let quizQueue = [];
    function refreshVocabTable(){
      const tb = $('#vTable tbody'); tb.innerHTML='';
      vocab.forEach((w,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${escapeHTML(w.fr)}</td><td>${escapeHTML(w.en)}</td><td class="small">${w.due}</td><td><button class="btn bad small" data-del="${w.id}">Sup.</button></td>`;
        tb.appendChild(tr);
      });
      tb.onclick = (e)=>{ const id=e.target.getAttribute('data-del'); if(id){ vocab=vocab.filter(x=>x.id!=id); store.set(K.vocabList,vocab); refreshVocabTable(); updateDueCount(); } };
    }
    function updateDueCount(){
      const today=fmt(todayKey());
      const due=vocab.filter(v=> v.due<=today).length;
      $('#dueCount').textContent = due;
      $('#dueNow').textContent = due;
    }
    function addVocab(fr,en){
      const id = Date.now();
      vocab.push({id, fr, en, ease:2.5, interval:0, reps:0, due:fmt(todayKey())});
      store.set(K.vocabList,vocab);
      refreshVocabTable(); updateDueCount();
    }
    $('#addWord').onclick = ()=>{
      const fr=$('#vFr').value.trim(); const en=$('#vEn').value.trim();
      if(!fr||!en) return;
      addVocab(fr,en); $('#vFr').value=''; $('#vEn').value='';
    };
    $('#exportVocab').onclick = ()=>{
      const blob = new Blob([JSON.stringify(vocab,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='vocab.json'; a.click();
      URL.revokeObjectURL(url);
    };
    $('#importVocab').onchange = (e)=>{
      const f=e.target.files[0]; if(!f) return;
      const r=new FileReader(); r.onload=()=>{ try{ const arr=JSON.parse(r.result); if(Array.isArray(arr)){ vocab=arr; store.set(K.vocabList,vocab); refreshVocabTable(); updateDueCount(); } }catch{} }; r.readAsText(f);
    };
    $('#clearVocab').onclick = ()=>{ if(confirm('Effacer tout le vocabulaire ?')){ vocab=[]; store.set(K.vocabList,vocab); refreshVocabTable(); updateDueCount(); } };

    // Quiz
    let currentCard=null;
    $('#startQuiz').onclick = ()=>{
      const today=fmt(todayKey());
      quizQueue = vocab.filter(v=> v.due<=today);
      if(!quizQueue.length){ alert("Aucune carte due. Ajoutez des mots ou attendez le prochain rappel."); return; }
      serveNextCard();
    };
    $('#skipCard').onclick = ()=> serveNextCard();
    function serveNextCard(){
      currentCard = quizQueue.shift();
      if(!currentCard){ $('#quizFront h2').textContent='Terminé 👏'; disableRate(true); $('#markVocabXP').disabled=false; return; }
      $('#quizFront h2').textContent=currentCard.fr;
      $('#quizAnswer').value = ''; $('#quizBack').textContent = '';
      disableRate(true); $('#revealA').disabled=false; $('#skipCard').disabled=false;
    }
    function disableRate(dis){
      ['rateAgain','rateHard','rateGood','rateEasy'].forEach(id=> $('#'+id).disabled = dis);
    }
    $('#revealA').onclick = ()=>{
      if(!currentCard) return;
      $('#quizBack').textContent = currentCard.en;
      disableRate(false); $('#revealA').disabled=true;
    };
    $('#rateAgain').onclick = ()=> rateCard(0);
    $('#rateHard').onclick = ()=> rateCard(2);
    $('#rateGood').onclick = ()=> rateCard(3);
    $('#rateEasy').onclick = ()=> rateCard(4);
    $('#markVocabXP').onclick = ()=>{ addXP(5,'vocab'); $('#markVocabXP').disabled=true; };

    function rateCard(grade){
      // Minimal SM-2 style
      const c=currentCard;
      if(grade<3){
        c.reps=0; c.interval=1; c.ease=Math.max(1.3, c.ease-0.2);
      } else {
        c.reps+=1;
        if(c.reps===1) c.interval=1;
        else if(c.reps===2) c.interval=3;
        else c.interval = Math.round(c.interval * c.ease);
        c.ease = Math.min(3.0, c.ease + (grade===4?0.15:0.0));
      }
      const next = addDays(new Date(), c.interval);
      c.due = fmt(next);
      // save
      const idx = vocab.findIndex(v=>v.id===c.id);
      if(idx>-1) vocab[idx]=c; store.set(K.vocabList,vocab);
      refreshVocabTable(); updateDueCount();
      serveNextCard();
    }

    /* ===========================
       Daily Phrases
       =========================== */
    const PHRASES = [
      "Bonjour, comment ça va ?",
      "Je m’appelle Nicklas. Enchanté(e).",
      "Pouvez-vous répéter, s’il vous plaît ?",
      "Je suis à un niveau A2, je voudrais atteindre B2.",
      "Où se trouve la gare, s’il vous plaît ?",
      "Combien ça coûte ?",
      "Je cherche un bon restaurant dans le quartier.",
      "J’ai besoin d’aide avec mon français.",
      "Je préfère parler plus lentement.",
      "Merci beaucoup ! / De rien.",
      "Je voudrais réserver une table pour deux.",
      "Est-ce que je peux promener mon chien ici ?",
      "C’est possible d’essayer ?",
      "Je comprends / Je ne comprends pas.",
      "Je vais vérifier et je reviens."
    ];
    function todaysPhraseIndexes(){
      // deterministic 10 phrases/day based on date
      const seed = parseInt((store.get(K.dueSeed) ?? Date.now()).toString().slice(-6),10);
      const day = parseInt(todayKey().replace(/-/g,''),10);
      const rand = (n)=> (Math.abs(Math.sin(seed+day+n))*10000)%PHRASES.length|0;
      const set=new Set();
      while(set.size<10 && set.size<PHRASES.length) set.add(rand(set.size));
      return [...set];
    }
    function renderPhrases(){
      const list = todaysPhraseIndexes().map(i=>PHRASES[i]);
      const c = $('#phraseList'); c.innerHTML='';
      list.forEach((p,i)=>{
        const row=document.createElement('div');
        row.className='row'; row.style.marginBottom='6px';
        const btn=document.createElement('button'); btn.className='btn'; btn.textContent='🔊';
        btn.onclick=()=> speak(p);
        const span=document.createElement('span'); span.textContent = (i+1)+'. '+p;
        row.appendChild(btn); row.appendChild(span); c.appendChild(row);
      });
    }
    function speak(text){
      if(!('speechSynthesis' in window)){ alert("Synthèse vocale non disponible."); return; }
      speechSynthesis.cancel();
      const u=new SpeechSynthesisUtterance(text); u.lang='fr-FR'; u.rate=1; speechSynthesis.speak(u);
    }
    $('#speakAllPhrases').onclick = ()=>{
      PHRASES.forEach((p,i)=> setTimeout(()=>speak(p), i*1500));
    };
    $('#newPhrases').onclick = ()=>{ store.set(K.dueSeed, Date.now()); renderPhrases(); };
    $('#markPhrasesXP').onclick = ()=> addXP(5,'phrases');

    /* ===========================
       Helpers
       =========================== */
    function escapeHTML(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

    /* ===========================
       INIT
       =========================== */
    function init(){
      initTabs();
      refreshVocabTable(); updateDueCount();
      renderArticle(); setPrompt('daily'); renderPhrases();
      refreshProgress(); draw14DayChart(); setB2Countdown();

      // Wire dashboard +xp buttons
      document.querySelectorAll('#view-dashboard [data-flag]').forEach(btn=>{
        btn.onclick = ()=> addXP(parseInt(btn.dataset.xp,10), btn.dataset.flag);
      });

      // Resize canvas correctly after first paint
      const c=$('#chart14'); const rect=c.getBoundingClientRect();
      c.width = Math.floor(rect.width * (window.devicePixelRatio||1));
      c.height = Math.floor(150 * (window.devicePixelRatio||1));
      draw14DayChart();
      window.addEventListener('resize', ()=>{
        const r=c.getBoundingClientRect();
        c.width=Math.floor(r.width*(window.devicePixelRatio||1));
        c.height=Math.floor(150*(window.devicePixelRatio||1));
        draw14DayChart();
      });
    }
    init();
  </script>
</body>
</html>
