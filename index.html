<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>French Development</title>
  <meta name="description" content="French learning app â€” single-file version" />
  <style>
    :root{
      --bg1:#0b1020; --bg2:#111827; --fg:#e5e7eb; --muted:#cbd5e1;
      --card:rgba(255,255,255,.06); --brd:rgba(255,255,255,.14);
      --accent:#60a5fa; --ok:#34d399; --warn:#fbbf24; --bad:#f87171;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--fg);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:
        radial-gradient(1000px 700px at 15% -10%, #1e293b 0%, transparent 60%),
        radial-gradient(900px 700px at 85% 10%, #0f172a 0%, transparent 55%),
        linear-gradient(180deg,var(--bg2),var(--bg1));
    }
    a{color:#93c5fd}
    .wrap{max-width:1000px;margin:0 auto;padding:24px}
    .card{background:var(--card);border:1px solid var(--brd);border-radius:16px;padding:20px;margin-bottom:18px}
    h1{margin:0 0 8px;font-size:1.6rem}
    h2{margin:8px 0 12px;font-size:1.15rem}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .btn{
      border:1px solid var(--brd); background:rgba(255,255,255,.06);
      padding:10px 12px;border-radius:10px;color:var(--fg);cursor:pointer;
    }
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn.ok{border-color:rgba(16,185,129,.35);background:rgba(16,185,129,.15)}
    .btn.bad{border-color:rgba(248,113,113,.35);background:rgba(248,113,113,.15)}
    .k{padding:2px 8px;border-radius:999px;border:1px solid var(--brd);background:rgba(255,255,255,.05)}
    .muted{color:var(--muted)}
    .bar{height:12px;background:rgba(255,255,255,.08);border:1px solid var(--brd);border-radius:999px;overflow:hidden}
    .bar>span{display:block;height:100%;background:linear-gradient(90deg,#60a5fa,#34d399)}
    textarea{width:100%;min-height:160px;border:1px solid var(--brd);border-radius:12px;background:rgba(0,0,0,.25);color:var(--fg);padding:12px}
    input[type="text"]{width:100%;border:1px solid var(--brd);border-radius:10px;background:rgba(0,0,0,.25);color:var(--fg);padding:10px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    td,th{border-bottom:1px solid var(--brd);padding:8px 6px}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--brd);background:rgba(255,255,255,.06);font-size:.85rem}
    .small{font-size:.9rem}
    .section{margin-top:4px}
    hr{border:none;border-top:1px solid var(--brd);opacity:.6;margin:12px 0}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ğŸ‡«ğŸ‡· French Development</h1>
      <p class="muted small">Single-file version. No build tools needed. Data saves in your browser.</p>
      <div class="row small">
        <span id="micState" class="pill">ğŸ™ï¸ Micro: <span class="mono">checkingâ€¦</span></span>
        <span id="recState" class="pill">ğŸ—£ï¸ Parole: <span class="mono">inactive</span></span>
        <span id="ttsState" class="pill">ğŸ”Š Ã‰coute: <span class="mono">stopped</span></span>
      </div>
    </div>

    <!-- Progress -->
    <div class="card">
      <h2>ğŸ“ˆ Progression du jour</h2>
      <div class="row">
        <div><span class="muted">Objectif:</span> <span id="goalVal" class="k mono">20 xp</span></div>
        <button class="btn" id="decGoal">-</button>
        <button class="btn" id="incGoal">+</button>
        <div><span class="muted">GagnÃ©:</span> <span id="xpVal" class="k mono">0</span></div>
      </div>
      <div class="bar section"><span id="xpBar" style="width:0%"></span></div>
      <div class="row section">
        <button class="btn" data-xp="5" id="markListening">+5 Ã‰coute</button>
        <button class="btn" data-xp="5" id="markSpeaking">+5 Parler</button>
        <button class="btn" data-xp="5" id="markReading">+5 Lecture</button>
        <button class="btn" data-xp="5" id="markVocab">+5 Vocabulaire</button>
        <button class="btn" id="resetDay">RÃ©initialiser la journÃ©e</button>
      </div>
      <p class="muted small">Conseil : visez 20â€“30 xp par jour. Le suivi se rÃ©initialise chaque jour.</p>
    </div>

    <!-- Comprehension -->
    <div class="card">
      <h2>ğŸ“° ComprÃ©hension (A2 â†’ B1)</h2>
      <div class="row">
        <button class="btn" id="loadSample">Charger un texte</button>
        <button class="btn" id="toggleLang">Afficher la traduction (EN)</button>
        <button class="btn" id="speakText">ğŸ”Š Ã‰couter</button>
        <button class="btn" id="stopSpeak">â¸ï¸ Stop</button>
      </div>
      <p class="muted small">Astuce : cliquez sur <em>Ã‰couter</em> pour TTS en franÃ§ais. Si rien ne parle, votre navigateur bloque la lecture automatique â€” recliquez.</p>
      <textarea id="newsText"></textarea>
      <div id="questions" class="section small"></div>
      <div class="row section">
        <button class="btn ok" id="markCompDone">Marquer comme fait (+5)</button>
      </div>
    </div>

    <!-- Speaking -->
    <div class="card">
      <h2>ğŸ¤ Parler</h2>
      <div class="row">
        <button class="btn" id="askMic">Autoriser le micro</button>
        <button class="btn" id="startRec">Parler</button>
        <button class="btn bad" id="stopRec" disabled>ArrÃªter</button>
      </div>
      <p class="muted small">La reconnaissance vocale utilise lâ€™API du navigateur (<span class="mono">SpeechRecognition</span>). Si elle nâ€™est pas disponible, vous pouvez toujours tester le micro.</p>
      <textarea id="speechOut" placeholder="Votre transcription apparaÃ®tra iciâ€¦"></textarea>
    </div>

    <!-- Vocabulary -->
    <div class="card">
      <h2>ğŸ“š Vocabulaire</h2>
      <div class="row">
        <input id="vFr" type="text" placeholder="mot (FR) â€” ex: envisager" />
        <input id="vEn" type="text" placeholder="translation (EN) â€” ex: to consider" />
        <button class="btn" id="addWord">Ajouter</button>
        <button class="btn" id="exportVocab">Exporter</button>
        <button class="btn bad" id="clearVocab">Effacer</button>
      </div>
      <table id="vTable">
        <thead><tr><th>FR</th><th>EN</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
      <hr />
      <div class="row">
        <button class="btn" id="startQuiz">Quiz (FRâ†’EN)</button>
        <button class="btn" id="revealQuiz" disabled>RÃ©vÃ©ler</button>
        <span id="quizPrompt" class="k"></span>
        <span id="quizAnswer" class="k" style="display:none"></span>
      </div>
    </div>

    <div class="card small muted">
      <p>ProblÃ¨mes de micro ? Allez dans les rÃ©glages du navigateur â†’ ConfidentialitÃ©/Microphone et autorisez <span class="mono">github.io</span>. Le site fonctionne hors connexion; toutes les donnÃ©es sont stockÃ©es uniquement dans votre navigateur (localStorage).</p>
    </div>
  </div>

  <script>
    /* ===== Utilities & Storage ===== */
    const $ = (sel) => document.querySelector(sel);
    const todayKey = () => new Date().toISOString().slice(0,10);
    const store = {
      get(k, def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def } catch { return def } },
      set(k, v){ localStorage.setItem(k, JSON.stringify(v)) }
    };

    /* ===== Progress ===== */
    const xpKey = (d=todayKey()) => `frdev_xp_${d}`;
    const goalKey = 'frdev_goal';
    const flagsKey = (d=todayKey()) => `frdev_done_${d}`;

    const goalEl = $('#goalVal'), xpEl = $('#xpVal'), barEl = $('#xpBar');
    const btnInc = $('#incGoal'), btnDec = $('#decGoal'), btnReset = $('#resetDay');
    const buttons = {
      listening: $('#markListening'),
      speaking: $('#markSpeaking'),
      reading: $('#markReading'),
      vocab: $('#markVocab'),
      comp: $('#markCompDone'),
    };

    function loadProgress(){
      const goal = store.get(goalKey, 20);
      const xp = store.get(xpKey(), 0);
      const done = store.get(flagsKey(), {listening:false,speaking:false,reading:false,vocab:false,comp:false});
      goalEl.textContent = goal + ' xp';
      xpEl.textContent = xp;
      barEl.style.width = Math.min(100, Math.round((xp/goal)*100)) + '%';
      // Disable completed
      for (const k of Object.keys(buttons)){
        buttons[k].disabled = !!done[k];
      }
    }
    function addXP(amount, flag){
      const xp = store.get(xpKey(), 0) + amount;
      store.set(xpKey(), xp);
      const done = store.get(flagsKey(), {listening:false,speaking:false,reading:false,vocab:false,comp:false});
      done[flag] = true; store.set(flagsKey(), done);
      loadProgress();
    }
    btnInc.onclick = () => { const g = store.get(goalKey,20)+5; store.set(goalKey,g); loadProgress(); };
    btnDec.onclick = () => { const g = Math.max(5, store.get(goalKey,20)-5); store.set(goalKey,g); loadProgress(); };
    btnReset.onclick = () => { store.set(xpKey(),0); store.set(flagsKey(), {listening:false,speaking:false,reading:false,vocab:false,comp:false}); loadProgress(); };
    buttons.listening.onclick = () => addXP(5,'listening');
    buttons.speaking.onclick  = () => addXP(5,'speaking');
    buttons.reading.onclick   = () => addXP(5,'reading');
    buttons.vocab.onclick     = () => addXP(5,'vocab');
    buttons.comp.onclick      = () => addXP(5,'comp');

    /* ===== Comprehension ===== */
    const newsBox = $('#newsText');
    const qBox = $('#questions');
    const ttsState = $('#ttsState');

    const samples = [
      {
        title: "Le vÃ©lo en ville",
        fr: "Aujourdâ€™hui, la mairie a ouvert une nouvelle piste cyclable au centre-ville pour rÃ©duire la circulation et la pollution. Les habitants disent que la piste est large et sÃ»re. Les commerÃ§ants espÃ¨rent voir plus de clients, car il sera plus facile dâ€™accÃ©der aux magasins Ã  vÃ©lo.",
        en: "Today, the city hall opened a new bike lane downtown to reduce traffic and pollution. Residents say the lane is wide and safe. Shop owners hope to see more customers because it will be easier to reach stores by bike.",
        qs: [
          "Pourquoi la mairie a-t-elle ouvert une nouvelle piste cyclable ?",
          "Que pensent les habitants de la piste ?",
          "Quâ€™espÃ¨rent les commerÃ§ants ?"
        ],
        ans: [
          "Pour rÃ©duire la circulation et la pollution.",
          "Elle est large et sÃ»re.",
          "Avoir plus de clients grÃ¢ce Ã  lâ€™accÃ¨s plus facile aux magasins."
        ]
      },
      {
        title: "La mÃ©tÃ©o et lâ€™agriculture",
        fr: "AprÃ¨s plusieurs semaines de pluie, les agriculteurs profitent enfin du soleil pour rÃ©colter. Les experts disent que la qualitÃ© sera correcte, mais certains fruits sont plus petits que dâ€™habitude. Les marchÃ©s locaux restent bien approvisionnÃ©s.",
        en: "After several weeks of rain, farmers are finally enjoying the sun to harvest. Experts say quality will be fine, but some fruits are smaller than usual. Local markets remain well supplied.",
        qs: [
          "Quel temps faisait-il ces derniÃ¨res semaines ?",
          "Quel est lâ€™impact sur les fruits ?",
          "Comment vont les marchÃ©s locaux ?"
        ],
        ans: [
          "Il a plu pendant plusieurs semaines.",
          "Certains fruits sont plus petits que dâ€™habitude.",
          "Ils restent bien approvisionnÃ©s."
        ]
      },
      {
        title: "Le train du matin",
        fr: "La compagnie ferroviaire a ajoutÃ© deux trains le matin pour Ã©viter la foule aux heures de pointe. Les voyageurs remarquent des trajets plus calmes et plus rapides. Lâ€™entreprise surveille la frÃ©quentation avant de dÃ©cider de nouvelles lignes.",
        en: "The railway company added two morning trains to avoid crowds at rush hour. Travelers are noticing calmer, faster rides. The company is monitoring ridership before deciding on new routes.",
        qs: [
          "Combien de trains ont Ã©tÃ© ajoutÃ©s le matin ?",
          "Quâ€™est-ce que les voyageurs remarquent ?",
          "Que fera lâ€™entreprise ensuite ?"
        ],
        ans: [
          "Deux trains.",
          "Des trajets plus calmes et plus rapides.",
          "Elle surveillera la frÃ©quentation avant de dÃ©cider de nouvelles lignes."
        ]
      }
    ];
    let showEN = false, sampleIndex = 0;
    function renderComprehension(){
      const s = samples[sampleIndex % samples.length];
      newsBox.value = showEN ? s.en : s.fr;
      qBox.innerHTML = `
        <div><span class="pill">Texte: ${s.title}</span></div>
        <ol class="small">
          ${s.qs.map((q,i)=>`<li>${q} <details class="muted"><summary>RÃ©ponse suggÃ©rÃ©e</summary>${s.ans[i]}</details></li>`).join('')}
        </ol>
      `;
    }
    $('#loadSample').onclick = ()=>{ sampleIndex++; renderComprehension(); };
    $('#toggleLang').onclick = ()=>{ showEN = !showEN; $('#toggleLang').textContent = showEN?'Afficher le texte (FR)':'Afficher la traduction (EN)'; renderComprehension(); };

    // Text-to-speech
    let speaking = false;
    function speak(text){
      if (!('speechSynthesis' in window)){ alert("La synthÃ¨se vocale n'est pas disponible dans ce navigateur."); return; }
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'fr-FR';
      u.rate = 0.95; u.pitch = 1;
      u.onstart = ()=>{ speaking = true; ttsState.innerHTML = 'ğŸ”Š Ã‰coute: <span class="mono">playing</span>'; };
      u.onend   = ()=>{ speaking = false; ttsState.innerHTML = 'ğŸ”Š Ã‰coute: <span class="mono">stopped</span>'; };
      speechSynthesis.speak(u);
    }
    $('#speakText').onclick = ()=> speak(newsBox.value.trim() || "Bonjour ! CommenÃ§ons la pratique de franÃ§ais.");
    $('#stopSpeak').onclick = ()=> { speechSynthesis.cancel(); ttsState.innerHTML = 'ğŸ”Š Ã‰coute: <span class="mono">stopped</span>'; };

    /* ===== Microphone & Speech Recognition ===== */
    const micState = $('#micState'), recState = $('#recState'), out = $('#speechOut');
    async function askMic(){
      try{
        const stream = await navigator.mediaDevices.getUserMedia({audio:true});
        stream.getTracks().forEach(t=>t.stop());
        micState.innerHTML = 'ğŸ™ï¸ Micro: <span class="mono">granted</span>';
      }catch(e){
        micState.innerHTML = 'ğŸ™ï¸ Micro: <span class="mono">blocked</span>';
        alert("Permission micro refusÃ©e. Ouvrez les rÃ©glages du navigateur et autorisez le micro pour github.io");
      }
    }
    $('#askMic').onclick = askMic;

    // Status on load
    (async function initMicStatus(){
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        micState.innerHTML = 'ğŸ™ï¸ Micro: <span class="mono">unsupported</span>'; return;
      }
      try{
        if (navigator.permissions && navigator.permissions.query){
          const r = await navigator.permissions.query({name:'microphone'});
          micState.innerHTML = 'ğŸ™ï¸ Micro: <span class="mono">'+r.state+'</span>';
          r.onchange = ()=> micState.innerHTML = 'ğŸ™ï¸ Micro: <span class="mono">'+r.state+'</span>';
        } else {
          micState.innerHTML = 'ğŸ™ï¸ Micro: <span class="mono">unknown</span>';
        }
      }catch{ micState.innerHTML = 'ğŸ™ï¸ Micro: <span class="mono">unknown</span>'; }
    })();

    // Speech recognition (Chrome/WebKit only)
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recog = null;
    function startRec(){
      if (!SR){ alert("La reconnaissance vocale n'est pas disponible dans ce navigateur. Essayez Chrome."); return; }
      if (recog){ return; }
      recog = new SR();
      recog.lang = 'fr-FR';
      recog.interimResults = true;
      recog.continuous = true;
      out.value = '';
      recog.onresult = (e)=>{
        let txt = '';
        for (let i=0;i<e.results.length;i++){
          txt += e.results[i][0].transcript + (e.results[i].isFinal ? '\n' : ' ');
        }
        out.value = txt.trim();
      };
      recog.onerror = (e)=>{ console.warn(e); };
      recog.onend = ()=>{ recState.innerHTML = 'ğŸ—£ï¸ Parole: <span class="mono">inactive</span>'; $('#stopRec').disabled = true; recog = null; };
      try{
        recog.start();
        recState.innerHTML = 'ğŸ—£ï¸ Parole: <span class="mono">listeningâ€¦</span>';
        $('#stopRec').disabled = false;
      }catch(err){
        alert("Impossible de dÃ©marrer l'Ã©coute. Essayez d'autoriser le micro puis rÃ©essayez.");
      }
    }
    function stopRec(){ if (recog){ recog.stop(); } }
    $('#startRec').onclick = startRec;
    $('#stopRec').onclick = stopRec;

    /* ===== Vocabulary ===== */
    const vKey = 'frdev_vocab';
    const vTable = $('#vTable tbody');
    function loadVocab(){
      let list = store.get(vKey, null);
      if (!list){
        list = [
          {fr:'envisager', en:'to consider'},
          {fr:'mettre en place', en:'to set up'},
          {fr:'piste cyclable', en:'bike lane'},
        ];
        store.set(vKey, list);
      }
      renderVocab(list);
    }
    function renderVocab(list){
      vTable.innerHTML = list.map((w,i)=>`
        <tr>
          <td>${w.fr}</td>
          <td>${w.en}</td>
          <td><button class="btn bad small" data-del="${i}">Supprimer</button></td>
        </tr>
      `).join('');
    }
    $('#addWord').onclick = ()=>{
      const fr = $('#vFr').value.trim(), en = $('#vEn').value.trim();
      if(!fr || !en) return;
      const list = store.get(vKey, []);
      list.push({fr,en}); store.set(vKey, list);
      $('#vFr').value=''; $('#vEn').value='';
      renderVocab(list);
      addXP(5,'vocab');
    };
    vTable.addEventListener('click', (e)=>{
      const i = e.target.getAttribute('data-del');
      if(i!=null){
        const list = store.get(vKey, []);
        list.splice(+i,1); store.set(vKey, list); renderVocab(list);
      }
    });
    $('#exportVocab').onclick = ()=>{
      const blob = new Blob([JSON.stringify(store.get(vKey,[]),null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download='vocab.json'; a.click();
      URL.revokeObjectURL(url);
    };
    $('#clearVocab').onclick = ()=>{ if(confirm('Effacer tout le vocabulaire?')){ store.set(vKey, []); renderVocab([]); } };

    // Quiz
    let quizIdx = -1;
    $('#startQuiz').onclick = ()=>{
      const list = store.get(vKey, []);
      if(!list.length){ alert('Ajoutez des mots dâ€™abord.'); return; }
      quizIdx = Math.floor(Math.random()*list.length);
      $('#quizPrompt').textContent = list[quizIdx].fr;
      $('#quizAnswer').style.display='none';
      $('#quizAnswer').textContent = list[quizIdx].en;
      $('#revealQuiz').disabled = false;
    };
    $('#revealQuiz').onclick = ()=>{ $('#quizAnswer').style.display='inline-block'; };

    /* ===== Init ===== */
    function init(){
      loadProgress();
      loadVocab();
      renderComprehension(); // load first sample
    }
    init();
  </script>
</body>
</html>
