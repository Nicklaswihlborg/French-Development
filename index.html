<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>French Development â€” Coach</title>
<meta name="description" content="A single-file French learning coach with speaking, listening, comprehension, vocabulary SRS, phrases, goals & progress."/>
<style>
  :root{
    --bg1:#0b1020; --bg2:#111827; --fg:#e5e7eb; --muted:#cbd5e1;
    --card:rgba(255,255,255,.06); --brd:rgba(255,255,255,.14);
    --accent:#60a5fa; --ok:#34d399; --warn:#fbbf24; --bad:#f87171;
    --focus: #a78bfa;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--fg);
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    background:
      radial-gradient(1000px 700px at 15% -10%, #1e293b 0%, transparent 60%),
      radial-gradient(900px 700px at 85% 10%, #0f172a 0%, transparent 55%),
      linear-gradient(180deg,var(--bg2),var(--bg1));
  }
  a{color:#93c5fd}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  .card{background:var(--card);border:1px solid var(--brd);border-radius:16px;padding:20px;margin-bottom:18px}
  h1{margin:0 0 8px;font-size:1.7rem}
  h2{margin:6px 0 12px;font-size:1.2rem}
  h3{margin:6px 0 8px;font-size:1.05rem}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .stack{display:grid;gap:10px}
  .btn{
    border:1px solid var(--brd); background:rgba(255,255,255,.06);
    padding:9px 12px;border-radius:10px;color:var(--fg);cursor:pointer;
  }
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn.ok{border-color:rgba(16,185,129,.35);background:rgba(16,185,129,.15)}
  .btn.warn{border-color:rgba(251,191,36,.35);background:rgba(251,191,36,.15)}
  .btn.bad{border-color:rgba(248,113,113,.35);background:rgba(248,113,113,.15)}
  .btn.primary{border-color:rgba(96,165,250,.5);background:rgba(96,165,250,.2)}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--brd);background:rgba(255,255,255,.06);font-size:.85rem}
  .k{padding:2px 8px;border-radius:999px;border:1px solid var(--brd);background:rgba(255,255,255,.05)}
  .muted{color:var(--muted)}
  .small{font-size:.9rem}
  .bar{height:12px;background:rgba(255,255,255,.08);border:1px solid var(--brd);border-radius:999px;overflow:hidden}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,#60a5fa,#34d399)}
  textarea{width:100%;min-height:130px;border:1px solid var(--brd);border-radius:12px;background:rgba(0,0,0,.25);color:var(--fg);padding:12px}
  input[type="text"], input[type="number"], select{
    width:100%;border:1px solid var(--brd);border-radius:10px;background:rgba(0,0,0,.25);color:var(--fg);padding:10px
  }
  table{width:100%;border-collapse:collapse;margin-top:10px}
  td,th{border-bottom:1px solid var(--brd);padding:8px 6px;vertical-align:top}
  hr{border:none;border-top:1px solid var(--brd);opacity:.6;margin:12px 0}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .tab{padding:8px 10px;border-radius:10px;border:1px solid var(--brd);cursor:pointer}
  .tab.active{border-color:rgba(96,165,250,.5);background:rgba(96,165,250,.2)}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:900px){ .grid-2{grid-template-columns:1fr} }
  .heat{display:grid;grid-template-columns:repeat(15,12px);gap:4px}
  .box{width:12px;height:12px;border-radius:3px;border:1px solid var(--brd);background:rgba(255,255,255,.06)}
  .box.l1{background:#0ea5e9} .box.l2{background:#22c55e} .box.l3{background:#a3e635} .box.l0{background:rgba(255,255,255,.08)}
  canvas{width:100%;height:180px;border:1px solid var(--brd);border-radius:12px;background:rgba(255,255,255,.04)}
  details summary{cursor:pointer}
  .focus-ring:focus { outline: 2px solid var(--focus); outline-offset: 2px; }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>ğŸ‡«ğŸ‡· French Development â€” Coach</h1>
    <p class="muted small">Single-file app. Works offline. Progress stored in your browser (localStorage). Target: B2 by end of year.</p>
    <div class="row small">
      <span id="micState" class="pill">ğŸ™ï¸ Micro: <span class="mono">checkingâ€¦</span></span>
      <span id="recState" class="pill">ğŸ—£ï¸ Parole: <span class="mono">inactive</span></span>
      <span id="ttsState" class="pill">ğŸ”Š Ã‰coute: <span class="mono">stopped</span></span>
      <span id="streakState" class="pill">ğŸ”¥ SÃ©rie: <span class="mono">0</span> jours</span>
      <span id="levelState" class="pill">ğŸ¯ Niveau: <span class="mono">A2</span></span>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div class="card" id="dash">
    <h2>ğŸ“Š Tableau de bord</h2>
    <div class="grid-2">
      <div class="stack">
        <div class="row">
          <div><span class="muted">Objectif quotidien:</span> <span id="goalDaily" class="k mono">30 xp</span></div>
          <button class="btn" id="decGoal">-</button>
          <button class="btn" id="incGoal">+</button>
          <div><span class="muted">GagnÃ© aujourdâ€™hui:</span> <span id="xpToday" class="k mono">0</span></div>
        </div>
        <div class="bar"><span id="xpBar" style="width:0%"></span></div>
        <div class="row">
          <button class="btn ok" data-xp="5" id="btnMarkListening">+5 Ã‰coute</button>
          <button class="btn ok" data-xp="5" id="btnMarkSpeaking">+5 Parler</button>
          <button class="btn ok" data-xp="5" id="btnMarkReading">+5 Lecture</button>
          <button class="btn ok" data-xp="5" id="btnMarkVocab">+5 Vocabulaire</button>
          <button class="btn warn" id="resetToday">RÃ©initialiser la journÃ©e</button>
        </div>
        <div class="row small">
          <span class="muted">Objectif hebdo:</span>
          <input id="weeklyGoal" type="number" min="50" step="10" class="focus-ring" style="max-width:120px"/>
          <button class="btn" id="saveWeeklyGoal">Enregistrer</button>
          <span class="muted">Cumul semaine:</span> <span id="xpWeek" class="k mono">0</span>
        </div>
      </div>
      <div class="stack">
        <div class="row small"><strong>ActivitÃ© (30 derniers jours)</strong></div>
        <div id="heatmap" class="heat" aria-label="calendar heatmap"></div>
        <canvas id="weeklyChart" aria-label="weekly xp chart"></canvas>
      </div>
    </div>
  </div>

  <!-- TABS -->
  <div class="card">
    <div class="tabs">
      <div class="tab active" data-tab="phrases">Phrases</div>
      <div class="tab" data-tab="listening">Ã‰couter</div>
      <div class="tab" data-tab="speaking">Parler</div>
      <div class="tab" data-tab="comprehension">ComprÃ©hension</div>
      <div class="tab" data-tab="vocab">Vocabulaire (SRS)</div>
      <div class="tab" data-tab="settings">RÃ©glages</div>
      <div class="tab" data-tab="data">DonnÃ©es</div>
    </div>

    <!-- PHRASES -->
    <section id="phrases" class="stack section">
      <h2>ğŸ“… Phrases du jour</h2>
      <p class="muted small">EntraÃ®ne-toi chaque jour avec 10 phrases frÃ©quentes. Lis Ã  voix haute, Ã©coute avec TTS, puis essaie sans regarder.</p>
      <div class="row">
        <button class="btn primary" id="newPhrases">Nouvelles phrases</button>
        <button class="btn" id="speakAll">ğŸ”Š Tout Ã©couter</button>
        <button class="btn ok" id="phrasesDone">Marquer comme fait (+5)</button>
      </div>
      <table id="phrasesTable"><thead><tr><th>FR</th><th>EN</th><th>ğŸ”Š</th><th>MaÃ®trisÃ©</th></tr></thead><tbody></tbody></table>
    </section>

    <!-- LISTENING -->
    <section id="listening" class="stack section" style="display:none">
      <h2>ğŸ‘‚ Ã‰coute guidÃ©e</h2>
      <div class="row">
        <button class="btn" id="listenPlay">ğŸ”Š Lire</button>
        <button class="btn" id="listenStop">â¸ï¸ Stop</button>
        <select id="listenMode" style="max-width:220px">
          <option value="mcq">QCM (choix multiple)</option>
          <option value="dict">DictÃ©e (tapez ce que vous entendez)</option>
        </select>
        <button class="btn ok" id="listeningDone">Marquer comme fait (+5)</button>
      </div>
      <div class="stack">
        <div id="listenPrompt" class="pill"></div>
        <div id="listenMCQ" class="row"></div>
        <textarea id="listenDict" placeholder="Tapez iciâ€¦ (mode dictÃ©e)" style="display:none"></textarea>
        <div id="listenFeedback" class="small"></div>
      </div>
    </section>

    <!-- SPEAKING -->
    <section id="speaking" class="stack section" style="display:none">
      <h2>ğŸ¤ Parler</h2>
      <div class="row">
        <button class="btn" id="askMic">Autoriser le micro</button>
        <button class="btn" id="startRec">Parler</button>
        <button class="btn bad" id="stopRec" disabled>ArrÃªter</button>
        <button class="btn ok" id="speakingDone">Marquer comme fait (+5)</button>
      </div>
      <p class="muted small">Dites la phrase affichÃ©e. On compare votre transcription Ã  la phrase attendue (approximation) pour un score.</p>
      <div class="row">
        <span id="speakTarget" class="pill"></span>
        <button class="btn" id="nextPrompt">Nouvelle phrase</button>
        <button class="btn" id="playTarget">ğŸ”Š Ã‰couter la cible</button>
      </div>
      <textarea id="speechOut" placeholder="Votre transcription apparaÃ®tra iciâ€¦"></textarea>
      <div id="speakScore" class="small"></div>
    </section>

    <!-- COMPREHENSION -->
    <section id="comprehension" class="stack section" style="display:none">
      <h2>ğŸ“° ComprÃ©hension (A2 â†’ B1)</h2>
      <div class="row">
        <button class="btn" id="loadSample">Charger un texte</button>
        <button class="btn" id="toggleLang">Afficher la traduction (EN)</button>
        <button class="btn" id="speakText">ğŸ”Š Ã‰couter</button>
        <button class="btn" id="stopSpeak">â¸ï¸ Stop</button>
        <button class="btn ok" id="compDone">Marquer comme fait (+5)</button>
      </div>
      <textarea id="newsText"></textarea>
      <div class="row small">
        <button class="btn" id="makeCloze">GÃ©nÃ©rer Cloze (mots cachÃ©s)</button>
        <button class="btn" id="showAnswers">RÃ©vÃ©ler</button>
      </div>
      <div id="clozeBox" class="small"></div>
      <div id="questions" class="section small"></div>
      <p class="muted small">Collez votre propre article si vous voulez. (Certains sites bloquent la copie automatique â€” collez le texte manuellement.)</p>
    </section>

    <!-- VOCAB -->
    <section id="vocab" class="stack section" style="display:none">
      <h2>ğŸ“š Vocabulaire â€” Leitner SRS</h2>
      <p class="muted small">RÃ©visez les cartes dues aujourdâ€™hui. Notation: Â« Encore Â», Â« Difficile Â», Â« Bien Â», Â« Facile Â» â€” la carte passe Ã  une boÃ®te supÃ©rieure et revient plus tard.</p>
      <div class="row">
        <input id="vFr" type="text" placeholder="mot (FR) â€” ex: envisager"/>
        <input id="vEn" type="text" placeholder="translation (EN) â€” ex: to consider"/>
        <button class="btn" id="addWord">Ajouter</button>
        <button class="btn" id="importVocab">Importer</button>
        <button class="btn" id="exportVocab">Exporter</button>
        <button class="btn bad" id="clearVocab">Effacer</button>
      </div>
      <div class="row small">
        <span>Cartes totales: <span id="vCount" class="k mono">0</span></span>
        <span>Ã€ rÃ©viser aujourdâ€™hui: <span id="vDue" class="k mono">0</span></span>
      </div>
      <div id="reviewBox" class="card" style="background:rgba(0,0,0,.18)">
        <div id="noDue" class="muted">Rien Ã  rÃ©viser. Ajoutez des mots ou revenez plus tard.</div>
        <div id="dueCard" style="display:none">
          <div class="row"><span id="cardFront" class="pill"></span><button class="btn" id="flipCard">RÃ©vÃ©ler</button></div>
          <div class="row" id="cardBack" style="display:none"><span class="pill" id="cardBackTxt"></span></div>
          <div class="row section">
            <button class="btn bad" id="gradeAgain">Encore</button>
            <button class="btn" id="gradeHard">Difficile</button>
            <button class="btn ok" id="gradeGood">Bien</button>
            <button class="btn primary" id="gradeEasy">Facile</button>
            <button class="btn" id="speakCard">ğŸ”Š Ã‰couter</button>
          </div>
        </div>
      </div>
      <table id="vTable">
        <thead><tr><th>FR</th><th>EN</th><th>BoÃ®te</th><th>Ã‰chÃ©ance</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- SETTINGS -->
    <section id="settings" class="stack section" style="display:none">
      <h2>âš™ï¸ RÃ©glages</h2>
      <div class="grid-2">
        <div class="stack">
          <label>Niveau cible
            <select id="targetLevel">
              <option>A2</option>
              <option selected>B1</option>
              <option>B2">B2</option>
              <option>C1">C1</option>
            </select>
          </label>
          <label>Voix TTS (si dispo)
            <select id="voiceSelect"></select>
          </label>
          <label>Vitesse TTS
            <input id="ttsRate" type="number" min="0.5" max="1.2" step="0.05" value="0.95"/>
          </label>
          <label>Langue de reconnaissance
            <input id="recLang" type="text" value="fr-FR"/>
          </label>
        </div>
        <div class="stack">
          <h3>Objectifs</h3>
          <label>XP quotidien
            <input id="dailyGoalInput" type="number" min="10" step="5"/>
          </label>
          <label>XP hebdomadaire
            <input id="weeklyGoalInput" type="number" min="50" step="10"/>
          </label>
          <button class="btn ok" id="saveGoals">Sauvegarder</button>
        </div>
      </div>
      <p class="muted small">Astuce: pour B2 dâ€™ici dÃ©cembre, viser ~30â€“60 min/jour (20â€“40 XP), 5â€“6 jours/semaine, plus 2 sessions longues/sem.</p>
    </section>

    <!-- DATA -->
    <section id="data" class="stack section" style="display:none">
      <h2>ğŸ’¾ DonnÃ©es</h2>
      <div class="row">
        <button class="btn" id="exportAll">Exporter tout</button>
        <input id="importAllInput" type="file" accept=".json"/>
        <button class="btn" id="importAllBtn">Importer</button>
        <button class="btn bad" id="wipeAll">Tout effacer</button>
      </div>
      <details>
        <summary>Voir les clÃ©s de stockage</summary>
        <pre id="debugDump" class="small mono"></pre>
      </details>
    </section>
  </div>

  <div class="card small muted">
    <p>Conseils dâ€™apprentissage (rÃ©sumÃ©s des bonnes pratiques) : combine quotidiennement <strong>comprÃ©hension</strong> + <strong>Ã©coute</strong> + <strong>parler</strong> + <strong>rÃ©vision SRS</strong>. Ã‰talonne des objectifs rÃ©alistes (20â€“40 XP/j, 140â€“250 XP/sem), garde une <strong>sÃ©rie</strong>, et utilise la rÃ©pÃ©tition espacÃ©e. Fais 2 sessions Â« longues Â» par semaine (60â€“90 min) axÃ©es sur lecture + synthÃ¨se orale.</p>
  </div>
</div>

<script>
/* =========================
   Utilities & Persistence
   ========================= */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const todayKey = () => new Date().toISOString().slice(0,10);
const dateAdd = (d, days) => { const t = new Date(d); t.setDate(t.getDate()+days); return t.toISOString().slice(0,10); };
const fmtDate = d => d;

const store = {
  get(k, def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def } catch { return def } },
  set(k, v){ localStorage.setItem(k, JSON.stringify(v)) },
  del(k){ localStorage.removeItem(k) },
  keys(){ return Object.keys(localStorage) }
};

const K = {
  profile: 'fdv3_profile',
  settings: 'fdv3_settings',
  xpDaily: (d=todayKey()) => `fdv3_xp_${d}`,
  flagsDaily: (d=todayKey()) => `fdv3_flags_${d}`,
  goals: 'fdv3_goals',
  streak: 'fdv3_streak',
  history: 'fdv3_hist', // { 'YYYY-MM-DD': xp }
  phrases: 'fdv3_phrases',
  vocab: 'fdv3_vocab'
};

function ensureDefaults(){
  if(!store.get(K.settings)) store.set(K.settings, {voice:null, rate:0.95, recLang:'fr-FR', targetLevel:'A2'});
  if(!store.get(K.goals)) store.set(K.goals, {daily:30, weekly:200});
  if(!store.get(K.streak)) store.set(K.streak, {count:0, last: null});
  if(!store.get(K.history)) store.set(K.history, {});
  if(!store.get(K.phrases)) store.set(K.phrases, {mastered:{}, lastSet:[], lastDay:null});
  if(!store.get(K.vocab)) {
    store.set(K.vocab, [
      {fr:'envisager', en:'to consider', box:1, nextDue:todayKey(), last:null},
      {fr:'mettre en place', en:'to set up', box:1, nextDue:todayKey(), last:null},
      {fr:'piste cyclable', en:'bike lane', box:1, nextDue:todayKey(), last:null}
    ]);
  }
}
ensureDefaults();

/* =========================
   Dashboard: XP, Goals, Streaks
   ========================= */
const goalDailyEl = $('#goalDaily'), xpTodayEl = $('#xpToday'), xpBarEl = $('#xpBar');
const xpWeekEl = $('#xpWeek'), weeklyGoalInput = $('#weeklyGoal'), saveWeeklyGoalBtn = $('#saveWeeklyGoal');
const decGoalBtn = $('#decGoal'), incGoalBtn = $('#incGoal'), resetTodayBtn = $('#resetToday');
const streakState = $('#streakState'), levelState = $('#levelState');

function getGoals(){ return store.get(K.goals, {daily:30, weekly:200}); }
function setGoals(g){ store.set(K.goals, g); }
function addXP(amount){
  const d = todayKey();
  const key = K.xpDaily(d);
  const cur = store.get(key, 0) + amount;
  store.set(key, cur);
  const hist = store.get(K.history, {}); hist[d] = cur; store.set(K.history, hist);
  updateStreak(cur);
  renderDashboard();
}
function setXP(val){
  const d = todayKey();
  store.set(K.xpDaily(d), val);
  const hist = store.get(K.history, {}); hist[d] = val; store.set(K.history, hist);
  updateStreak(val);
  renderDashboard();
}
function updateStreak(todayXp){
  const s = store.get(K.streak);
  const yesterday = dateAdd(todayKey(), -1);
  if (s.last !== todayKey()){
    // if yesterday had xp and today starting fresh, continue else reset if gap
    const hist = store.get(K.history, {});
    if (s.last === yesterday || s.last === null){
      // determine if new day started with xp
      if (todayXp>0) { s.count = (s.last===yesterday ? s.count+1 : (s.count || 0)+1); s.last = todayKey(); }
      else { /* wait until xp added to increment */ }
    } else {
      // gap
      if (todayXp>0){ s.count = 1; s.last = todayKey(); } else { s.count = 0; s.last = null; }
    }
  } else {
    if (todayXp===0){ /* don't change */ }
  }
  store.set(K.streak, s);
}

function weekRangeEnd(endDate=todayKey()){
  const end = new Date(endDate);
  const start = new Date(endDate); start.setDate(end.getDate()-6);
  return {start: start.toISOString().slice(0,10), end:endDate};
}
function weekSum(endDate=todayKey()){
  const hist = store.get(K.history, {});
  const {start,end} = weekRangeEnd(endDate);
  let sum=0; const d0 = new Date(start);
  for(let i=0;i<7;i++){ const d = new Date(d0); d.setDate(d0.getDate()+i);
    sum += (hist[d.toISOString().slice(0,10)]||0);
  }
  return sum;
}

function renderHeatmap(){
  const hist = store.get(K.history, {});
  const container = $('#heatmap'); container.innerHTML='';
  // last 30 days
  const end = new Date(todayKey()); for(let i=29;i>=0;i--){
    const d = new Date(end); d.setDate(end.getDate()-i);
    const k = d.toISOString().slice(0,10);
    const xp = hist[k]||0;
    const div = document.createElement('div');
    div.className = 'box ' + (xp>=30?'l3': xp>=10?'l2': xp>0?'l1':'l0');
    div.title = `${k}: ${xp} xp`;
    container.appendChild(div);
  }
}

function renderWeeklyChart(){
  const canvas = $('#weeklyChart');
  const ctx = canvas.getContext('2d');
  const hist = store.get(K.history, {});
  // compute last 8 weeks sums
  const weeks = [];
  let end = new Date(todayKey());
  for(let w=0; w<8; w++){
    const endStr = end.toISOString().slice(0,10);
    weeks.unshift({label: endStr, total: weekSum(endStr)});
    end.setDate(end.getDate()-7);
  }
  // clear
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const W = canvas.width, H = canvas.height, pad=24;
  const max = Math.max(50, ...weeks.map(x=>x.total));
  const barW = (W - pad*2) / (weeks.length*1.2);
  weeks.forEach((wk,i)=>{
    const x = pad + i*barW*1.2;
    const h = (H - pad*2) * (wk.total/max);
    ctx.fillStyle = 'rgba(96,165,250,.8)';
    ctx.fillRect(x, H-pad-h, barW, h);
    ctx.fillStyle = 'rgba(226,232,240,.9)';
    ctx.font = '12px system-ui';
    ctx.fillText(String(wk.total), x, H-pad-h-4);
  });
  ctx.strokeStyle='rgba(255,255,255,.2)';
  ctx.strokeRect(pad, pad, W-pad*2, H-pad*2);
}

function renderDashboard(){
  const goals = getGoals();
  const xp = store.get(K.xpDaily(todayKey()), 0);
  goalDailyEl.textContent = goals.daily+' xp';
  xpTodayEl.textContent = xp;
  xpBarEl.style.width = Math.min(100, Math.round((xp/goals.daily)*100))+'%';
  weeklyGoalInput.value = getGoals().weekly;
  xpWeekEl.textContent = weekSum();
  // streak
  const s = store.get(K.streak);
  streakState.innerHTML = `ğŸ”¥ SÃ©rie: <span class="mono">${s.count||0}</span> jours`;
  renderHeatmap();
  renderWeeklyChart();
}
$('#btnMarkListening').onclick = ()=> addXP(5);
$('#btnMarkSpeaking').onclick  = ()=> addXP(5);
$('#btnMarkReading').onclick   = ()=> addXP(5);
$('#btnMarkVocab').onclick     = ()=> addXP(5);
decGoalBtn.onclick = ()=>{ const g=getGoals(); g.daily=Math.max(10,g.daily-5); setGoals(g); renderDashboard(); };
incGoalBtn.onclick = ()=>{ const g=getGoals(); g.daily=g.daily+5; setGoals(g); renderDashboard(); };
resetTodayBtn.onclick = ()=>{ setXP(0); };
saveWeeklyGoalBtn.onclick = ()=>{ const g=getGoals(); g.weekly = Math.max(50, Number(weeklyGoalInput.value)||g.weekly); setGoals(g); renderDashboard(); };

/* =========================
   Tabs
   ========================= */
$$('.tab').forEach(t => t.addEventListener('click', () => {
  $$('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  ['phrases','listening','speaking','comprehension','vocab','settings','data'].forEach(id=>{
    $( '#'+id ).style.display = (t.dataset.tab===id)?'block':'none';
  });
}));

/* =========================
   TTS + Mic + SpeechRecognition
   ========================= */
const ttsState = $('#ttsState');
let voiceList = []; let voiceId = null;
function refreshVoices(){
  if(!('speechSynthesis' in window)) return;
  voiceList = window.speechSynthesis.getVoices();
  const sel = $('#voiceSelect'); sel.innerHTML='';
  voiceList.filter(v=>v.lang.startsWith('fr')).concat(voiceList.filter(v=>!v.lang.startsWith('fr'))).forEach((v,i)=>{
    const opt = document.createElement('option');
    opt.value = v.name; opt.textContent = `${v.name} (${v.lang})`; sel.appendChild(opt);
  });
  const saved = store.get(K.settings).voice;
  if(saved){
    sel.value = saved;
  } else if (voiceList.find(v=>v.lang==='fr-FR')) {
    sel.value = voiceList.find(v=>v.lang==='fr-FR').name;
  }
}
if ('speechSynthesis' in window){
  window.speechSynthesis.onvoiceschanged = refreshVoices;
  setTimeout(refreshVoices, 200);
}

function speak(text){
  if (!('speechSynthesis' in window)) { alert("SynthÃ¨se vocale indisponible"); return; }
  window.speechSynthesis.cancel();
  const s = store.get(K.settings);
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'fr-FR';
  u.rate = Number(s.rate||0.95);
  const v = voiceList.find(v=>v.name === s.voice);
  if(v) u.voice = v;
  u.onstart = ()=> ttsState.innerHTML='ğŸ”Š Ã‰coute: <span class="mono">playing</span>';
  u.onend = ()=> ttsState.innerHTML='ğŸ”Š Ã‰coute: <span class="mono">stopped</span>';
  speechSynthesis.speak(u);
}

$('#voiceSelect').addEventListener('change',(e)=>{
  const s = store.get(K.settings); s.voice = e.target.value; store.set(K.settings, s);
});
$('#ttsRate').addEventListener('change',(e)=>{
  const s = store.get(K.settings); s.rate = Number(e.target.value)||0.95; store.set(K.settings, s);
});

const micState = $('#micState'), recState = $('#recState'), recLangInput = $('#recLang');
async function askMic(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    stream.getTracks().forEach(t=>t.stop());
    micState.innerHTML = 'ğŸ™ï¸ Micro: <span class="mono">granted</span>';
  }catch(e){
    micState.innerHTML = 'ğŸ™ï¸ Micro: <span class="mono">blocked</span>';
    alert("Permission micro refusÃ©e. Autorisez le micro pour github.io");
  }
}
$('#askMic').onclick = askMic;

(async function initMicStatus(){
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    micState.innerHTML = 'ğŸ™ï¸ Micro: <span class="mono">unsupported</span>'; return;
  }
  try{
    if (navigator.permissions && navigator.permissions.query){
      const r = await navigator.permissions.query({name:'microphone'});
      micState.innerHTML = 'ğŸ™ï¸ Micro: <span class="mono">'+r.state+'</span>';
      r.onchange = ()=> micState.innerHTML = 'ğŸ™ï¸ Micro: <span class="mono">'+r.state+'</span>';
    } else {
      micState.innerHTML = 'ğŸ™ï¸ Micro: <span class="mono">unknown</span>';
    }
  }catch{ micState.innerHTML = 'ğŸ™ï¸ Micro: <span class="mono">unknown</span>'; }
})();

const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
let recog = null, recognizing = false;
function startRec(){
  if (!SR){ alert("Reconnaissance vocale indisponible (essayez Chrome)"); return; }
  if (recognizing) return;
  recog = new SR();
  recog.lang = (recLangInput.value || 'fr-FR');
  recog.interimResults = true; recog.continuous = true;
  $('#speechOut').value = '';
  recog.onresult = (e)=>{
    let txt=''; for (let i=0;i<e.results.length;i++){
      txt += e.results[i][0].transcript + (e.results[i].isFinal?'\n':' ');
    }
    $('#speechOut').value = txt.trim();
    evalSpeaking(); // live update
  };
  recog.onerror = (e)=> console.warn('SR error', e);
  recog.onend = ()=>{ recognizing=false; recState.innerHTML='ğŸ—£ï¸ Parole: <span class="mono">inactive</span>'; $('#stopRec').disabled=true; };
  try{
    recog.start(); recognizing=true; recState.innerHTML='ğŸ—£ï¸ Parole: <span class="mono">listeningâ€¦</span>'; $('#stopRec').disabled=false;
  }catch(e){ alert("Impossible de dÃ©marrer l'Ã©coute"); }
}
function stopRec(){ if(recog){ recog.stop(); } }
$('#startRec').onclick = startRec; $('#stopRec').onclick = stopRec;

/* =========================
   Daily Phrases
   ========================= */
const PHRASE_BANK = [
  {fr:"Comment Ã§a va ?", en:"How are you?"},
  {fr:"Je m'appelle Nicklas.", en:"My name is Nicklas."},
  {fr:"Pouvez-vous rÃ©pÃ©ter, s'il vous plaÃ®t ?", en:"Could you repeat, please?"},
  {fr:"Je suis dÃ©butant, parlez lentement.", en:"I'm a beginner, speak slowly."},
  {fr:"OÃ¹ sont les toilettes ?", en:"Where is the restroom?"},
  {fr:"Combien Ã§a coÃ»te ?", en:"How much is it?"},
  {fr:"Je ne comprends pas.", en:"I don't understand."},
  {fr:"Quel est le mot pourâ€¦ ?", en:"What's the word forâ€¦?"},
  {fr:"C'est une bonne idÃ©e.", en:"That's a good idea."},
  {fr:"J'apprends le franÃ§ais.", en:"I'm learning French."},
  {fr:"Je voudrais un cafÃ©, s'il vous plaÃ®t.", en:"I'd like a coffee, please."},
  {fr:"Ã€ quelle heure Ã§a ouvre ?", en:"What time does it open?"},
  {fr:"Je cherche la gare.", en:"I'm looking for the train station."},
  {fr:"Câ€™est prÃ¨s dâ€™ici ?", en:"Is it close to here?"},
  {fr:"Jâ€™ai besoin dâ€™aide.", en:"I need help."},
  {fr:"TrÃ¨s bien, merci.", en:"Very well, thanks."},
  {fr:"Bonne journÃ©e !", en:"Have a nice day!"},
  {fr:"Pouvons-nous parler en franÃ§ais ?", en:"Can we speak in French?"},
  {fr:"Je suis Ã  un niveau A2.", en:"I'm at an A2 level."},
  {fr:"Quel est le chemin le plus rapide ?", en:"What's the fastest way?"}
];
function getPhrasesState(){ return store.get(K.phrases, {mastered:{}, lastSet:[], lastDay:null}); }
function savePhrasesState(s){ store.set(K.phrases, s); }

function pickDailyPhrases(){
  const s = getPhrasesState();
  const today = todayKey();
  if (s.lastDay === today && s.lastSet.length){ renderPhrases(s.lastSet); return; }
  // pick 10: prefer not mastered
  const notMastered = PHRASE_BANK.filter(p=>!s.mastered[p.fr]);
  const pool = (notMastered.length>=10 ? notMastered : PHRASE_BANK);
  const shuffled=[...pool].sort(()=>Math.random()-0.5).slice(0,10);
  s.lastSet = shuffled; s.lastDay = today; savePhrasesState(s);
  renderPhrases(shuffled);
}
function renderPhrases(list){
  const tb = $('#phrasesTable tbody'); tb.innerHTML='';
  list.forEach((p,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.fr}</td>
      <td class="muted">${p.en}</td>
      <td><button class="btn" data-say="${i}">ğŸ”Š</button></td>
      <td><input type="checkbox" data-master="${i}"/></td>
    `;
    tb.appendChild(tr);
  });
}
$('#speakAll').onclick = ()=>{
  const s = getPhrasesState();
  (s.lastSet||[]).forEach((p,i)=> setTimeout(()=>speak(p.fr), i*1200));
};
$('#newPhrases').onclick = pickDailyPhrases;
$('#phrasesTable').addEventListener('click',(e)=>{
  const i = e.target.getAttribute('data-say');
  if(i!=null){ const p = getPhrasesState().lastSet[+i]; speak(p.fr); }
});
$('#phrasesTable').addEventListener('change',(e)=>{
  const i = e.target.getAttribute('data-master');
  if(i!=null){ const st = getPhrasesState(); const phr = st.lastSet[+i]; st.mastered[phr.fr]=true; savePhrasesState(st); }
});
$('#phrasesDone').onclick = ()=> addXP(5);

/* =========================
   Listening
   ========================= */
const listenItems = [
  {text:"Le train part Ã  huit heures du matin.", choices:["Ã  huit heures","Ã  neuf heures","Ã  midi"], correct:0},
  {text:"Jâ€™habite prÃ¨s de la gare mais je travaille en ville.", choices:["prÃ¨s de la gare","loin de la gare","dans la gare"], correct:0},
  {text:"AprÃ¨s le travail, je promÃ¨ne mon chien au parc.", choices:["au parc","au musÃ©e","au marchÃ©"], correct:0},
];
let listenIdx = 0;
function renderListening(){
  const item = listenItems[listenIdx % listenItems.length];
  $('#listenPrompt').textContent = `Phrase ${ (listenIdx%listenItems.length)+1 }`;
  const mode = $('#listenMode').value;
  $('#listenMCQ').innerHTML='';
  $('#listenDict').style.display = 'none';
  $('#listenFeedback').textContent = '';
  if (mode==='mcq'){
    item.choices.forEach((opt, i)=>{
      const b = document.createElement('button');
      b.className='btn'; b.textContent = opt;
      b.onclick = ()=>{
        const ok = (i===item.correct);
        $('#listenFeedback').innerHTML = ok ? 'âœ… Correct' : 'âŒ Faux';
        if (ok) addXP(5);
      };
      $('#listenMCQ').appendChild(b);
    });
  } else {
    $('#listenDict').style.display = 'block';
  }
}
$('#listenMode').onchange = renderListening;
$('#listenPlay').onclick = ()=>{
  const item = listenItems[listenIdx % listenItems.length];
  speak(item.text);
};
$('#listenStop').onclick = ()=> speechSynthesis.cancel();
$('#listeningDone').onclick = ()=> addXP(5);
$('#listenDict').addEventListener('blur', ()=>{
  const item = listenItems[listenIdx % listenItems.length];
  const typed = $('#listenDict').value.trim().toLowerCase();
  const target = item.text.trim().toLowerCase();
  const sim = similarity(typed, target);
  $('#listenFeedback').innerHTML = `Score: ${(sim*100|0)}%`;
  if (sim>0.85) addXP(5);
});
renderListening();

/* =========================
   Speaking (target prompts + scoring)
   ========================= */
const SPEAK_BANK = PHRASE_BANK.map(p=>p.fr).concat([
  "Je voudrais rÃ©server une table pour deux ce soir.",
  "Est-ce que vous pouvez me recommander un bon restaurant ?",
  "Je suis en train dâ€™apprendre le franÃ§ais pour le travail."
]);
function randomTarget(){
  return SPEAK_BANK[Math.floor(Math.random()*SPEAK_BANK.length)];
}
function setTarget(){ $('#speakTarget').textContent = randomTarget(); }
$('#nextPrompt').onclick = setTarget;
$('#playTarget').onclick = ()=> speak($('#speakTarget').textContent);
function norm(s){ return s.toLowerCase().replace(/[^\p{L}\p{N}\s']/gu,'').replace(/\s+/g,' ').trim(); }

function levenshtein(a,b){
  // basic Levenshtein
  const m = a.length, n = b.length;
  const dp = Array.from({length:m+1},()=>Array(n+1).fill(0));
  for(let i=0;i<=m;i++) dp[i][0]=i;
  for(let j=0;j<=n;j++) dp[0][j]=j;
  for(let i=1;i<=m;i++){
    for(let j=1;j<=n;j++){
      const c = a[i-1]===b[j-1]?0:1;
      dp[i][j] = Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+c);
    }
  }
  return dp[m][n];
}
function similarity(a,b){
  a=norm(a); b=norm(b);
  if(!a && !b) return 1;
  if(!a || !b) return 0;
  const dist = levenshtein(a,b);
  return 1 - dist / Math.max(a.length,b.length);
}
function evalSpeaking(){
  const ref = $('#speakTarget').textContent;
  const said = $('#speechOut').value || '';
  const s = similarity(said, ref);
  $('#speakScore').innerHTML = `SimilaritÃ© ~ ${(s*100|0)}%`;
  if (s>0.9) { $('#speakScore').innerHTML += ' âœ…'; }
}
$('#speakingDone').onclick = ()=> addXP(5);
setTarget();

/* =========================
   Comprehension (texts, Qs, cloze)
   ========================= */
const samples = [
  {
    title: "Le vÃ©lo en ville",
    fr: "Aujourdâ€™hui, la mairie a ouvert une nouvelle piste cyclable au centre-ville pour rÃ©duire la circulation et la pollution. Les habitants disent que la piste est large et sÃ»re. Les commerÃ§ants espÃ¨rent voir plus de clients, car il sera plus facile dâ€™accÃ©der aux magasins Ã  vÃ©lo.",
    en: "Today, the city hall opened a new bike lane downtown to reduce traffic and pollution. Residents say the lane is wide and safe. Shop owners hope to see more customers because it will be easier to reach stores by bike.",
    qs: [
      "Pourquoi la mairie a-t-elle ouvert une nouvelle piste cyclable ?",
      "Que pensent les habitants de la piste ?",
      "Quâ€™espÃ¨rent les commerÃ§ants ?"
    ],
    ans: [
      "Pour rÃ©duire la circulation et la pollution.",
      "Elle est large et sÃ»re.",
      "Avoir plus de clients grÃ¢ce Ã  lâ€™accÃ¨s plus facile aux magasins."
    ]
  },
  {
    title: "La mÃ©tÃ©o et lâ€™agriculture",
    fr: "AprÃ¨s plusieurs semaines de pluie, les agriculteurs profitent enfin du soleil pour rÃ©colter. Les experts disent que la qualitÃ© sera correcte, mais certains fruits sont plus petits que dâ€™habitude. Les marchÃ©s locaux restent bien approvisionnÃ©s.",
    en: "After several weeks of rain, farmers are finally enjoying the sun to harvest. Experts say quality will be fine, but some fruits are smaller than usual. Local markets remain well supplied.",
    qs: [
      "Quel temps faisait-il ces derniÃ¨res semaines ?",
      "Quel est lâ€™impact sur les fruits ?",
      "Comment vont les marchÃ©s locaux ?"
    ],
    ans: [
      "Il a plu pendant plusieurs semaines.",
      "Certains fruits sont plus petits que dâ€™habitude.",
      "Ils restent bien approvisionnÃ©s."
    ]
  },
  {
    title: "Le train du matin",
    fr: "La compagnie ferroviaire a ajoutÃ© deux trains le matin pour Ã©viter la foule aux heures de pointe. Les voyageurs remarquent des trajets plus calmes et plus rapides. Lâ€™entreprise surveille la frÃ©quentation avant de dÃ©cider de nouvelles lignes.",
    en: "The railway company added two morning trains to avoid crowds at rush hour. Travelers are noticing calmer, faster rides. The company is monitoring ridership before deciding on new routes.",
    qs: [
      "Combien de trains ont Ã©tÃ© ajoutÃ©s le matin ?",
      "Quâ€™est-ce que les voyageurs remarquent ?",
      "Que fera lâ€™entreprise ensuite ?"
    ],
    ans: [
      "Deux trains.",
      "Des trajets plus calmes et plus rapides.",
      "Elle surveillera la frÃ©quentation avant de dÃ©cider de nouvelles lignes."
    ]
  }
];
let showEN = false, sampleIndex = 0;
function renderComprehension(){
  const s = samples[sampleIndex % samples.length];
  $('#newsText').value = showEN ? s.en : s.fr;
  $('#questions').innerHTML = `
    <div><span class="pill">Texte: ${s.title}</span></div>
    <ol class="small">
      ${s.qs.map((q,i)=>`<li>${q} <details class="muted"><summary>RÃ©ponse suggÃ©rÃ©e</summary>${s.ans[i]}</details></li>`).join('')}
    </ol>
  `;
}
$('#loadSample').onclick = ()=>{ sampleIndex++; renderComprehension(); };
$('#toggleLang').onclick = ()=>{ showEN = !showEN; $('#toggleLang').textContent = showEN?'Afficher le texte (FR)':'Afficher la traduction (EN)'; renderComprehension(); };
$('#speakText').onclick = ()=> speak( $('#newsText').value.trim() || "Bonjour ! CommenÃ§ons la pratique de franÃ§ais." );
$('#stopSpeak').onclick = ()=> speechSynthesis.cancel();
$('#compDone').onclick = ()=> addXP(5);

// Cloze generator (hide ~8 keywords)
function makeClozeFromText(txt){
  const words = txt.split(/\s+/);
  const idxs = new Set();
  const targetCount = Math.min(8, Math.max(3, Math.floor(words.length/12)));
  while (idxs.size < targetCount){
    const i = Math.floor(Math.random()*words.length);
    const w = words[i].replace(/[.,;:!?()]/g,'');
    if (w.length>3) idxs.add(i);
  }
  const answers = [];
  const masked = words.map((w,i)=>{
    const clean = w.replace(/([.,;:!?()])/g,'');
    if (idxs.has(i)) { answers.push(clean); return w.replace(clean, '____'); }
    return w;
  }).join(' ');
  return {masked, answers};
}
$('#makeCloze').onclick = ()=>{
  const txt = $('#newsText').value.trim();
  if(!txt){ alert('Ajoutez un texte'); return; }
  const {masked, answers} = makeClozeFromText(txt);
  $('#clozeBox').innerHTML = `<p>${masked}</p><p class="muted small">RÃ©ponses cachÃ©es.</p>`;
  $('#showAnswers').onclick = ()=> $('#clozeBox').innerHTML = `<p>${masked}</p><p class="small">RÃ©ponses: ${answers.join(', ')}</p>`;
};

/* =========================
   Vocabulary â€” Leitner SRS
   ========================= */
function getVocab(){ return store.get(K.vocab, []); }
function setVocab(v){ store.set(K.vocab, v); }
function renderVocabTable(){
  const list = getVocab();
  const tb = $('#vTable tbody'); tb.innerHTML='';
  list.forEach((w,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${w.fr}</td><td class="muted">${w.en}</td><td>${w.box||1}</td><td>${w.nextDue||todayKey()}</td>
    <td><button class="btn bad small" data-del="${i}">Supprimer</button></td>`;
    tb.appendChild(tr);
  });
  $('#vCount').textContent = list.length;
  $('#vDue').textContent = dueCards().length;
}
$('#vTable').addEventListener('click', (e)=>{
  const i = e.target.getAttribute('data-del');
  if(i!=null){ const list=getVocab(); list.splice(+i,1); setVocab(list); renderVocabTable(); }
});
$('#addWord').onclick = ()=>{
  const fr = $('#vFr').value.trim(), en = $('#vEn').value.trim();
  if(!fr || !en) return;
  const list = getVocab();
  list.push({fr,en,box:1,nextDue:todayKey(),last:null});
  setVocab(list); $('#vFr').value=''; $('#vEn').value=''; renderVocabTable();
};
$('#exportVocab').onclick = ()=>{
  const blob = new Blob([JSON.stringify(getVocab(),null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='vocab.json'; a.click(); URL.revokeObjectURL(url);
};
$('#importVocab').onclick = ()=>{
  const inp = document.createElement('input'); inp.type='file'; inp.accept='.json';
  inp.onchange = () => {
    const f = inp.files[0]; const reader = new FileReader();
    reader.onload = e => { try{ const arr = JSON.parse(e.target.result); if(Array.isArray(arr)){ setVocab(arr); renderVocabTable(); } }catch{} };
    reader.readAsText(f);
  };
  inp.click();
};
$('#clearVocab').onclick = ()=>{ if(confirm('Effacer tout le vocabulaire?')){ setVocab([]); renderVocabTable(); } };

function boxIntervalDays(box){
  // Leitner-ish spacing
  return [0,1,2,4,7,14,30][box] || 30;
}
function scheduleNext(card, ease){
  // ease: 'again' | 'hard' | 'good' | 'easy'
  let box = card.box||1;
  if(ease==='again') box = 1;
  else if(ease==='hard') box = Math.max(1, box);
  else if(ease==='good') box = Math.min(5, box+1);
  else if(ease==='easy') box = Math.min(6, box+2);
  card.box = box;
  const days = boxIntervalDays(box);
  card.nextDue = dateAdd(todayKey(), days);
  card.last = todayKey();
  return card;
}
function dueCards(){
  const today = todayKey();
  return getVocab().filter(c => !c.nextDue || c.nextDue <= today);
}

const reviewUI = {
  noDue: $('#noDue'), dueCard: $('#dueCard'), front: $('#cardFront'),
  back: $('#cardBack'), backTxt: $('#cardBackTxt')
};
let currentCardIndex = null, currentPool = [];
function startReview(){
  currentPool = dueCards();
  if(!currentPool.length){
    reviewUI.noDue.style.display='block'; reviewUI.dueCard.style.display='none'; return;
  }
  reviewUI.noDue.style.display='none'; reviewUI.dueCard.style.display='block'; reviewUI.back.style.display='none';
  currentCardIndex = 0;
  showCard();
}
function showCard(){
  const card = currentPool[currentCardIndex];
  reviewUI.front.textContent = card.fr; reviewUI.backTxt.textContent = card.en;
}
$('#flipCard').onclick = ()=> reviewUI.back.style.display='block';
function grade(ease){
  const card = currentPool[currentCardIndex];
  scheduleNext(card, ease);
  const all = getVocab();
  const idx = all.findIndex(c => c.fr===card.fr && c.en===card.en);
  if(idx>=0){ all[idx]=card; setVocab(all); }
  currentCardIndex++;
  addXP(ease==='again'?0: (ease==='hard'?2: (ease==='good'?4:5)));
  if(currentCardIndex>=currentPool.length){ startReview(); } else { reviewUI.back.style.display='none'; showCard(); }
}
$('#gradeAgain').onclick = ()=> grade('again');
$('#gradeHard').onclick  = ()=> grade('hard');
$('#gradeGood').onclick  = ()=> grade('good');
$('#gradeEasy').onclick  = ()=> grade('easy');
$('#speakCard').onclick  = ()=> speak(reviewUI.front.textContent);

/* =========================
   Settings & Data
   ========================= */
function loadSettings(){
  const s = store.get(K.settings);
  $('#recLang').value = s.recLang||'fr-FR';
  $('#ttsRate').value = s.rate||0.95;
  $('#targetLevel').value = s.targetLevel||'A2';
  $('#dailyGoalInput').value = getGoals().daily;
  $('#weeklyGoalInput').value = getGoals().weekly;
}
$('#saveGoals').onclick = ()=>{
  const g = getGoals();
  g.daily = Math.max(10, Number($('#dailyGoalInput').value)||g.daily);
  g.weekly = Math.max(50, Number($('#weeklyGoalInput').value)||g.weekly);
  setGoals(g); renderDashboard();
  alert('Objectifs mis Ã  jour');
};
$('#recLang').addEventListener('change',(e)=>{ const s=store.get(K.settings); s.recLang=e.target.value; store.set(K.settings,s); });
$('#targetLevel').addEventListener('change',(e)=>{ const s=store.get(K.settings); s.targetLevel=e.target.value; store.set(K.settings,s); levelState.innerHTML = `ğŸ¯ Niveau: <span class="mono">${s.targetLevel}</span>`; });

$('#exportAll').onclick = ()=>{
  const data = {};
  store.keys().forEach(k=> data[k]=store.get(k));
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url
